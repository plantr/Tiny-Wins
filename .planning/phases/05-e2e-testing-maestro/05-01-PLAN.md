---
phase: 05-e2e-testing-maestro
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .maestro/config.yaml
  - scripts/seed-e2e-data.js
  - app/(tabs)/index.tsx
  - app/(tabs)/review.tsx
  - app/guided-builder.tsx
  - app/add-habit.tsx
  - components/habits/HabitGridCard.tsx
  - components/habits/HabitStackView.tsx
  - components/modals/AddHabitChoiceModal.tsx
  - components/modals/EvidenceModal.tsx
  - components/habits/builder/IdentityStep.tsx
  - components/habits/builder/HabitStep.tsx
  - components/habits/builder/IntentionStep.tsx
  - components/habits/builder/StackingStep.tsx
  - components/habits/builder/VersionsStep.tsx
  - components/habits/builder/SummaryStep.tsx
autonomous: true

must_haves:
  truths:
    - "Maestro workspace config exists and references flow directory"
    - "Seed script generates valid AsyncStorage-compatible fixture data for habits, logs, and reviews"
    - "All interactive elements needed by E2E flows have testID props in production code"
    - "Existing unit and integration tests still pass after testID additions"
  artifacts:
    - path: ".maestro/config.yaml"
      provides: "Maestro workspace configuration with flow directory and execution order"
      contains: "flows"
    - path: "scripts/seed-e2e-data.js"
      provides: "AsyncStorage seeding script for E2E test data"
      contains: "tinywins_habits"
  key_links:
    - from: ".maestro/config.yaml"
      to: ".maestro/flows/"
      via: "flows glob pattern"
      pattern: "flows/\\*"
    - from: "scripts/seed-e2e-data.js"
      to: "lib/habits-context.tsx"
      via: "AsyncStorage key names match context constants"
      pattern: "tinywins_habits|tinywins_logs|tinywins_reviews"
---

<objective>
Set up Maestro E2E testing infrastructure: workspace configuration, AsyncStorage seeding script, and testID instrumentation across all screens that E2E flows will interact with.

Purpose: Establish the foundation for E2E flow execution. Maestro needs testID selectors on interactive elements (per research recommendation for stability and cross-platform compatibility). The seed script provides deterministic test data. Config controls flow execution order.

Output: .maestro/config.yaml, scripts/seed-e2e-data.js, testID props on ~20 interactive elements across 10+ production files
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-e2e-testing-maestro/05-RESEARCH.md
@app/(tabs)/index.tsx
@app/(tabs)/review.tsx
@app/guided-builder.tsx
@components/habits/HabitGridCard.tsx
@components/modals/AddHabitChoiceModal.tsx
@components/modals/EvidenceModal.tsx
@components/habits/builder/SummaryStep.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Maestro workspace config and AsyncStorage seeding script</name>
  <files>
    .maestro/config.yaml
    scripts/seed-e2e-data.js
  </files>
  <action>
  **Create `.maestro/config.yaml`:**
  ```yaml
  flows:
    - 'flows/*'
  executionOrder:
    continueOnFailure: false
    flowsOrder:
      - habit-creation.yaml
      - habit-completion.yaml
      - weekly-review.yaml
  ```

  Execution order matters: habit-creation first (creates a habit), then habit-completion (completes it), then weekly-review (reviews the week). `continueOnFailure: false` stops on first failure to prevent cascading.

  **Create `scripts/seed-e2e-data.js`:**

  Node.js script that writes test fixture data directly to AsyncStorage's backing store on the iOS simulator. The script:

  1. Takes platform as first arg (`ios` or `android`) -- start with iOS only, document Android as TODO.
  2. Uses `xcrun simctl get_app_container booted com.myapp data` to find the app data container dynamically.
  3. Writes to the RCTAsyncLocalStorage_V1 directory (the actual AsyncStorage backing store).
  4. Seeds the following AsyncStorage keys:
     - `onboarding_completed` = `"true"` (skip onboarding)
     - `tinywins_fresh_v1` = `"true"` (skip fresh install clear)
     - `tinywins_habits` = JSON array with 2 habits:
       - Habit 1: `{ id: "e2e-habit-1", title: "Morning meditation", icon: "flower", iconColor: "#4DA6FF", gradientColors: ["#4DA6FF", "#7B61FF"], goal: 1, unit: "session", frequency: "daily", current: 0, streak: 3, bestStreak: 5, weekData: [1, 1, 1, 0, 0, 0, 0], createdAt: Date.now() - 86400000 * 7 }`
       - Habit 2: `{ id: "e2e-habit-2", title: "Read 10 pages", icon: "book", iconColor: "#00E5C3", gradientColors: ["#00E5C3", "#4DA6FF"], goal: 10, unit: "pages", frequency: "daily", current: 0, streak: 1, bestStreak: 3, weekData: [1, 0, 1, 0, 0, 0, 0], createdAt: Date.now() - 86400000 * 5 }`
     - `tinywins_logs` = JSON array with 5-6 logs for the seeded habits covering this week (use dynamic dates based on current date so they're always "this week"). Include done and missed statuses.
     - `tinywins_reviews` = empty array `[]` (so review flow can create one)
     - `tinywins_identity` = `JSON.stringify({ selectedIds: ["health", "learning"] })` (matches identity areas)
     - `app_theme_mode` = `"dark"` (consistent for screenshots)
     - `app_week_start_day` = `"monday"`

  5. For iOS, write a SQLite-compatible manifest or use the RCTAsyncLocalStorage approach. **IMPORTANT:** Expo's AsyncStorage on iOS uses a SQLite database at `Documents/RCTAsyncLocalStorage_V1`. The script should:
     - Find the app container via `xcrun simctl get_app_container booted com.myapp data`
     - Locate or create the `RCTAsyncLocalStorage_V1` SQLite database
     - Use Node.js `better-sqlite3` or alternatively just write key-value pairs using `child_process.execSync` to run `sqlite3` CLI commands against the database

  **Simpler alternative (preferred):** Since direct SQLite manipulation is complex, use a different approach:
  - Create the script to output the seed data as JSON to stdout
  - The npm orchestration script (Plan 02) will use Maestro's `runScript` or a custom approach to inject data
  - OR: Seed by launching the app with a special deep link/env flag that triggers seeding

  **Simplest approach (use this):** Write a script that:
  1. Finds the iOS simulator's app data directory
  2. Writes directly to the SQLite database used by AsyncStorage using the `sqlite3` CLI (available on macOS by default)
  3. The SQLite database path is: `{app_container}/Documents/RCTAsyncLocalStorage_V1`
  4. Table: `catalystLocalStorage` with columns `key TEXT PRIMARY KEY, value TEXT`
  5. Use `INSERT OR REPLACE INTO catalystLocalStorage (key, value) VALUES (?, ?)` for each key

  Script must be executable: add `#!/usr/bin/env node` shebang.

  Error handling: if `xcrun simctl` fails, print helpful error and exit 1. If SQLite write fails, log and exit 1.
  </action>
  <verify>
  - `ls .maestro/config.yaml` confirms config exists
  - `node scripts/seed-e2e-data.js --help` runs without error (or exits with usage message)
  - `cat .maestro/config.yaml` shows correct flow order
  - Script references correct AsyncStorage keys matching `lib/habits-context.tsx` constants
  </verify>
  <done>
  Maestro config.yaml defines flow execution order. Seed script can write test fixture data to AsyncStorage backing store for iOS simulator. Fixture data includes 2 habits, logs for current week, empty reviews, and identity/theme settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add testID props to all interactive elements needed by E2E flows</name>
  <files>
    app/(tabs)/index.tsx
    app/(tabs)/review.tsx
    app/guided-builder.tsx
    components/habits/HabitGridCard.tsx
    components/habits/HabitStackView.tsx
    components/modals/AddHabitChoiceModal.tsx
    components/modals/EvidenceModal.tsx
    components/habits/builder/IdentityStep.tsx
    components/habits/builder/HabitStep.tsx
    components/habits/builder/IntentionStep.tsx
    components/habits/builder/StackingStep.tsx
    components/habits/builder/VersionsStep.tsx
    components/habits/builder/SummaryStep.tsx
  </files>
  <action>
  Add `testID` props to interactive and assertable elements across all screens that E2E flows will tap, type into, or assert visibility on. Use descriptive, kebab-case testID names. testID is a standard React Native prop on all View, Text, Pressable, TextInput, etc. components.

  **Naming convention:** `{screen}-{element}-{qualifier}` where qualifier is optional.

  **Today screen (`app/(tabs)/index.tsx`):**
  - Add habit button (the green "+" Pressable): `testID="today-add-habit-button"`
  - Section title "your habits": `testID="today-habits-section"`
  - "daily activity" title: `testID="today-screen-title"`

  **HabitGridCard (`components/habits/HabitGridCard.tsx`):**
  - Outer card Pressable (the completion tap target): `testID={\`habit-card-${habit.id}\`}`
  - Streak text display: `testID={\`habit-streak-${habit.id}\`}`
  - Habit title text: `testID={\`habit-title-${habit.id}\`}`

  **HabitStackView (`components/habits/HabitStackView.tsx`):**
  - Stack item Pressable: `testID={\`habit-stack-${habit.id}\`}`

  **AddHabitChoiceModal (`components/modals/AddHabitChoiceModal.tsx`):**
  - Quick add option: `testID="choice-quick-add"`
  - Guided builder option: `testID="choice-guided-builder"`
  - Modal title "create a habit": `testID="choice-modal-title"`

  **EvidenceModal (`components/modals/EvidenceModal.tsx`):**
  - Skip button: `testID="evidence-skip-button"`
  - Note text input: `testID="evidence-note-input"`
  - Submit button (save evidence): `testID="evidence-submit-button"`

  **Guided builder (`app/guided-builder.tsx`):**
  - Next/Continue button: `testID="builder-next-button"`
  - Back button: `testID="builder-back-button"`
  - Step progress indicator container: `testID="builder-progress"`

  **IdentityStep (`components/habits/builder/IdentityStep.tsx`):**
  - Each identity area Pressable: `testID={\`builder-identity-${area.id}\`}` (using the area's id)
  - The first identity area (or whichever renders first) must be tappable by testID

  **HabitStep (`components/habits/builder/HabitStep.tsx`):**
  - Title input: `testID="builder-habit-title-input"`
  - Goal input: `testID="builder-habit-goal-input"`

  **IntentionStep (`components/habits/builder/IntentionStep.tsx`):**
  - Behaviour input: `testID="builder-intention-behaviour"`
  - Location input: `testID="builder-intention-location"`

  **StackingStep (`components/habits/builder/StackingStep.tsx`):**
  - No critical testIDs needed (flow can skip through with Next)

  **VersionsStep (`components/habits/builder/VersionsStep.tsx`):**
  - Two-minute version input: `testID="builder-two-min-input"`

  **SummaryStep (`components/habits/builder/SummaryStep.tsx`):**
  - Create habit button: `testID="builder-create-button"`
  - Habit title display on summary: `testID="builder-summary-title"`

  **Review screen (`app/(tabs)/review.tsx`):**
  - "write weekly review" button: `testID="review-write-button"`
  - Review modal title "weekly review": `testID="review-modal-title"`
  - "what worked" text input: `testID="review-what-worked-input"`
  - "what didn't work" text input: `testID="review-what-didnt-input"`
  - First law option (Make it Obvious): `testID="review-law-obvious"`
  - All law options: `testID={\`review-law-${law.key}\`}`
  - Submit/save review button: `testID="review-submit-button"`
  - Cancel button: `testID="review-cancel-button"`
  - Scorecard section: `testID="review-scorecard"`
  - Completed count: `testID="review-completed-count"`
  - Review history section (if reviews exist): `testID="review-history"`

  **IMPORTANT:** Only add `testID` props. Do NOT change any other behavior, styling, or logic. testID has zero runtime impact -- it's only used by testing frameworks.

  After adding testIDs, run `npx jest` to verify all existing tests still pass. testID additions should not break any tests since they're purely additive props.
  </action>
  <verify>
  - `npx jest` passes (all existing tests green)
  - `grep -r "testID" app/ components/ | wc -l` shows 20+ testID additions
  - Key testIDs present: `grep "today-add-habit-button" app/(tabs)/index.tsx`
  - Key testIDs present: `grep "builder-create-button" components/habits/builder/SummaryStep.tsx`
  - Key testIDs present: `grep "review-submit-button" app/(tabs)/review.tsx`
  - Key testIDs present: `grep "evidence-skip-button" components/modals/EvidenceModal.tsx`
  </verify>
  <done>
  All interactive elements needed by Maestro flows have testID props. Habit creation flow elements (choice modal, builder steps, create button), habit completion flow elements (habit card, evidence modal skip), and weekly review flow elements (write button, inputs, law selection, submit) are all addressable by Maestro's `id:` selector. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
- `.maestro/config.yaml` exists with correct flow ordering
- `scripts/seed-e2e-data.js` exists and is executable
- Seed script references all required AsyncStorage keys: tinywins_habits, tinywins_logs, tinywins_reviews, onboarding_completed, tinywins_fresh_v1, tinywins_identity, app_theme_mode
- 20+ testID props added across production files
- `npx jest` passes with zero new failures
- No behavioral changes to any production code (testID is purely additive)
</verification>

<success_criteria>
Maestro workspace is configured. AsyncStorage seeding script generates fixture data. All interactive elements for habit creation, habit completion, and weekly review flows have testID props. Existing test suite passes.
</success_criteria>

<output>
After completion, create `.planning/phases/05-e2e-testing-maestro/05-01-SUMMARY.md`
</output>
