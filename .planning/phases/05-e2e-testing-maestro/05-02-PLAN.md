---
phase: 05-e2e-testing-maestro
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .maestro/flows/habit-creation.yaml
  - .maestro/flows/habit-completion.yaml
  - .maestro/flows/weekly-review.yaml
  - package.json
  - scripts/run-e2e.sh
autonomous: false

must_haves:
  truths:
    - "Habit creation flow navigates the guided builder from start to a saved habit appearing on Today screen"
    - "Daily completion flow taps a habit card and verifies streak-related UI updates on screen"
    - "Weekly review flow opens the review modal, fills inputs, selects a law, submits, and confirms the review saved"
    - "Running a single npm command seeds data, starts Expo, runs Maestro flows, and reports pass/fail"
  artifacts:
    - path: ".maestro/flows/habit-creation.yaml"
      provides: "Maestro E2E flow for guided habit creation"
      contains: "builder-create-button"
    - path: ".maestro/flows/habit-completion.yaml"
      provides: "Maestro E2E flow for daily habit completion"
      contains: "habit-card-e2e-habit"
    - path: ".maestro/flows/weekly-review.yaml"
      provides: "Maestro E2E flow for weekly review submission"
      contains: "review-submit-button"
    - path: "scripts/run-e2e.sh"
      provides: "Full E2E orchestration: starts Expo, waits for ready, seeds, runs Maestro, cleans up"
      contains: "wait-on"
    - path: "package.json"
      provides: "npm script entry point delegating to orchestration shell script"
      contains: "test:e2e"
  key_links:
    - from: ".maestro/flows/habit-creation.yaml"
      to: "components/habits/builder/SummaryStep.tsx"
      via: "testID selector"
      pattern: "builder-create-button"
    - from: ".maestro/flows/habit-completion.yaml"
      to: "components/habits/HabitGridCard.tsx"
      via: "testID selector"
      pattern: "habit-card-e2e-habit"
    - from: ".maestro/flows/weekly-review.yaml"
      to: "app/(tabs)/review.tsx"
      via: "testID selector"
      pattern: "review-submit-button"
    - from: "package.json"
      to: "scripts/seed-e2e-data.js"
      via: "npm script invocation"
      pattern: "seed-e2e-data"
---

<objective>
Write three standalone Maestro E2E flows covering core user journeys (habit creation, daily completion, weekly review) and create npm script orchestration for one-command execution.

Purpose: Verify critical user paths work end-to-end on a real running app. These flows catch regressions that unit/integration tests miss -- navigation breaks, provider wiring issues, AsyncStorage persistence failures, and UI rendering bugs under real conditions.

Output: 3 Maestro flow YAML files, npm scripts for E2E orchestration, human verification of flows running
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-e2e-testing-maestro/05-RESEARCH.md
@.planning/phases/05-e2e-testing-maestro/05-01-SUMMARY.md
@app/(tabs)/index.tsx
@app/(tabs)/review.tsx
@app/guided-builder.tsx
@components/habits/builder/SummaryStep.tsx
@components/habits/HabitGridCard.tsx
@components/modals/EvidenceModal.tsx
@components/modals/AddHabitChoiceModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write three Maestro E2E flow files and npm orchestration scripts</name>
  <files>
    .maestro/flows/habit-creation.yaml
    .maestro/flows/habit-completion.yaml
    .maestro/flows/weekly-review.yaml
    package.json
    scripts/run-e2e.sh
  </files>
  <action>
  **All flows use `appId: com.myapp`** (from app.json: `ios.bundleIdentifier` and `android.package`).

  **Flow 1: `.maestro/flows/habit-creation.yaml`**

  Tests the guided builder from start to seeing the new habit on Today screen. App state is pre-seeded with 2 habits + onboarding completed, so the app launches directly to tabs.

  Steps:
  1. `- launchApp:` with `clearState: true` (clears app state for clean start)
     - Note: Since we clear state, the seed data needs to be injected AFTER clearState. Alternative: don't use clearState, rely on seed script. **Decision: Do NOT use clearState.** The seed script pre-populates data. Just use `- launchApp`.
  2. `- launchApp` -- app opens to entry screen, checks onboarding_completed, redirects to tabs
  3. Wait for Today screen to load: `- assertVisible: { id: "today-screen-title" }`
  4. `- takeScreenshot: habit-creation-01-today-loaded`
  5. Tap add habit button: `- tapOn: { id: "today-add-habit-button" }`
  6. Wait for choice modal: `- assertVisible: { id: "choice-modal-title" }`
  7. Tap guided builder option: `- tapOn: { id: "choice-guided-builder" }`
  8. Wait for builder to load (identity step): look for identity step content
  9. `- takeScreenshot: habit-creation-02-identity-step`
  10. Tap first identity area: `- tapOn: { id: "builder-identity-health" }` (or whichever first area is; use text fallback if needed)
  11. Tap Next: `- tapOn: { id: "builder-next-button", retryTapIfNoChange: false }`
  12. Wait for habit step: `- assertVisible: { id: "builder-habit-title-input" }`
  13. Tap title input and type: `- tapOn: { id: "builder-habit-title-input" }` then `- inputText: "E2E Test Habit"`
  14. Tap goal input if visible and enter value (check if required)
  15. Tap Next: `- tapOn: { id: "builder-next-button", retryTapIfNoChange: false }`
  16. On Intention step, fill behaviour: `- tapOn: { id: "builder-intention-behaviour" }` then `- inputText: "I will practice"`
  17. Fill location: `- tapOn: { id: "builder-intention-location" }` then `- inputText: "at home"`
  18. Tap Next: `- tapOn: { id: "builder-next-button", retryTapIfNoChange: false }`
  19. On Stacking step, tap Next (optional step): `- tapOn: { id: "builder-next-button", retryTapIfNoChange: false }`
  20. On Versions step, fill two-min version: `- tapOn: { id: "builder-two-min-input" }` then `- inputText: "Do it for 2 minutes"`
  21. Tap Next: `- tapOn: { id: "builder-next-button", retryTapIfNoChange: false }`
  22. On Summary step, verify title shows: `- assertVisible: "E2E Test Habit"`
  23. `- takeScreenshot: habit-creation-03-summary`
  24. Tap create: `- tapOn: { id: "builder-create-button", retryTapIfNoChange: false }`
  25. Wait for Today screen: `- assertVisible: { id: "today-screen-title" }`
  26. Verify new habit appears: `- assertVisible: "E2E Test Habit"`
  27. `- takeScreenshot: habit-creation-04-habit-created`

  **Important flow notes:**
  - Use `retryTapIfNoChange: false` on all navigation buttons to prevent double-tap (see pitfall 3 in research)
  - Before `inputText`, always tap the target input first
  - Use `- hideKeyboard` or `- tapOn: { point: "50%,10%" }` after text input if keyboard blocks next element
  - For keyboard dismissal on iOS, prefer tapping a non-interactive area: `- tapOn: { point: "50%,5%" }`

  **Flow 2: `.maestro/flows/habit-completion.yaml`**

  Tests tapping a pre-seeded habit to complete it. Pre-seeded state has "Morning meditation" (id: e2e-habit-1) with streak 3.

  Steps:
  1. `- launchApp`
  2. Wait for Today screen: `- assertVisible: { id: "today-screen-title" }`
  3. `- takeScreenshot: habit-completion-01-before`
  4. Tap on the habit card: `- tapOn: { id: "habit-card-e2e-habit-1" }`
  5. Wait for evidence modal: `- assertVisible: { id: "evidence-skip-button" }`
  6. `- takeScreenshot: habit-completion-02-evidence-modal`
  7. Skip evidence (tap skip): `- tapOn: { id: "evidence-skip-button", retryTapIfNoChange: false }`
  8. Wait for animation to settle: `- waitForAnimationToEnd: { timeout: 2000 }`
  9. Verify the habit card now shows completed state (the card should visually change)
  10. `- takeScreenshot: habit-completion-03-completed`

  **Note:** After completion, the streak should update. The exact streak text depends on the HabitGridCard rendering. Assert what's visible -- likely the streak count text. If the streak text is hard to assert precisely, at minimum assert the habit title is still visible and take screenshot for visual verification.

  **Flow 3: `.maestro/flows/weekly-review.yaml`**

  Tests writing a weekly review. Pre-seeded data has habits and logs but no reviews (reviews array is empty), so the "write weekly review" button should be visible.

  Steps:
  1. `- launchApp`
  2. Wait for Today screen: `- assertVisible: { id: "today-screen-title" }`
  3. Navigate to Review tab: `- tapOn: "Review"` (tab bar text selector -- works cross-platform)
  4. Wait for review screen: `- assertVisible: { id: "review-write-button" }`
  5. `- takeScreenshot: weekly-review-01-review-screen`
  6. Verify scorecard shows data: `- assertVisible: { id: "review-scorecard" }`
  7. Tap write review: `- tapOn: { id: "review-write-button", retryTapIfNoChange: false }`
  8. Wait for review modal: `- assertVisible: { id: "review-modal-title" }`
  9. `- takeScreenshot: weekly-review-02-review-modal`
  10. Tap what worked input: `- tapOn: { id: "review-what-worked-input" }`
  11. Type: `- inputText: "Meditation was consistent"`
  12. Dismiss keyboard: `- tapOn: { point: "50%,5%" }`
  13. Tap what didn't work input: `- tapOn: { id: "review-what-didnt-input" }`
  14. Type: `- inputText: "Skipped reading twice"`
  15. Dismiss keyboard: `- tapOn: { point: "50%,5%" }`
  16. Scroll down if needed to see law options: `- scrollUntilVisible: { element: { id: "review-law-obvious" }, direction: "DOWN" }`
  17. Select a law: `- tapOn: { id: "review-law-obvious" }`
  18. `- takeScreenshot: weekly-review-03-filled`
  19. Scroll to submit button: `- scrollUntilVisible: { element: { id: "review-submit-button" }, direction: "DOWN" }`
  20. Tap submit: `- tapOn: { id: "review-submit-button", retryTapIfNoChange: false }`
  21. Wait for modal to close and review to save: `- waitForAnimationToEnd: { timeout: 2000 }`
  22. Verify the "write weekly review" button is gone (review already submitted): `- assertNotVisible: { id: "review-write-button" }`
  23. `- takeScreenshot: weekly-review-04-submitted`

  **Add npm scripts to `package.json`:**

  Per user decision: the `test:e2e` script MUST be a fully automated single command that starts Expo, waits for ready, seeds data, runs Maestro, and cleans up. Install `wait-on` as a devDependency (`npm install --save-dev wait-on`) for detecting when the dev server is ready.

  Create a shell script `scripts/run-e2e.sh` (executable, `chmod +x`) that orchestrates the full flow:

  ```bash
  #!/usr/bin/env bash
  set -e

  # Cleanup function to kill Expo on exit (success or failure)
  cleanup() {
    if [ -n "$EXPO_PID" ]; then
      echo "[e2e] Stopping Expo dev server (PID $EXPO_PID)..."
      kill "$EXPO_PID" 2>/dev/null || true
      wait "$EXPO_PID" 2>/dev/null || true
    fi
  }
  trap cleanup EXIT

  echo "[e2e] Starting Expo dev server..."
  npx expo start --dev-client --ios &
  EXPO_PID=$!

  echo "[e2e] Waiting for Expo dev server to be ready..."
  npx wait-on http://localhost:8081 --timeout 60000

  echo "[e2e] Seeding AsyncStorage with test data..."
  node scripts/seed-e2e-data.js ios

  echo "[e2e] Running Maestro E2E flows..."
  maestro test .maestro/
  E2E_EXIT=$?

  echo "[e2e] Done. Cleaning up..."
  exit $E2E_EXIT
  ```

  Key details:
  - `npx expo start --dev-client --ios` launches the dev server and opens on iOS simulator in background
  - `wait-on http://localhost:8081` polls until the Metro bundler is ready (default 60s timeout)
  - After bundler is ready, seed data is written to AsyncStorage backing store
  - Maestro flows run against the live app
  - `trap cleanup EXIT` ensures Expo process is killed on success, failure, or interruption (Ctrl+C)
  - Capture Maestro exit code before cleanup so the script reports correct pass/fail

  Add these scripts to the `package.json` scripts section:
  ```json
  "test:e2e:seed": "node scripts/seed-e2e-data.js ios",
  "test:e2e:run": "maestro test .maestro/",
  "test:e2e": "bash scripts/run-e2e.sh"
  ```

  The `test:e2e:seed` and `test:e2e:run` scripts remain as granular entry points for manual/debug use. The main `test:e2e` delegates to the orchestration script for the full automated flow.

  Also update `files_modified` in plan frontmatter to include `scripts/run-e2e.sh`.
  </action>
  <verify>
  - `ls .maestro/flows/` shows all 3 flow files
  - `cat .maestro/flows/habit-creation.yaml` contains `appId: com.myapp` and `builder-create-button`
  - `cat .maestro/flows/habit-completion.yaml` contains `habit-card-e2e-habit-1` and `evidence-skip-button`
  - `cat .maestro/flows/weekly-review.yaml` contains `review-submit-button` and `review-what-worked-input`
  - `cat package.json | grep "test:e2e"` shows the orchestration scripts including `bash scripts/run-e2e.sh`
  - `ls -la scripts/run-e2e.sh` confirms script exists and is executable
  - `grep "wait-on" scripts/run-e2e.sh` confirms wait-on usage for Metro readiness
  - `grep "cleanup" scripts/run-e2e.sh` confirms trap-based cleanup of Expo process
  - `grep "wait-on" package.json` confirms wait-on is a devDependency
  - YAML syntax is valid: `python3 -c "import yaml; yaml.safe_load(open('.maestro/flows/habit-creation.yaml'))"` (or visual inspection)
  </verify>
  <done>
  Three standalone Maestro flows exist covering habit creation (guided builder end-to-end), habit completion (tap card, skip evidence), and weekly review (fill form, submit). Each flow captures screenshots at key checkpoints. `npm run test:e2e` is a fully automated single command: starts Expo dev server, waits for Metro bundler readiness via wait-on, seeds AsyncStorage, runs all Maestro flows, and kills Expo on exit. `wait-on` installed as devDependency.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Maestro flows execute against running app</name>
  <files>
    .maestro/flows/habit-creation.yaml
    .maestro/flows/habit-completion.yaml
    .maestro/flows/weekly-review.yaml
  </files>
  <action>
  This is a human verification checkpoint. Present the following instructions to the user.

  **Prerequisites (one-time setup):**
  1. Install Maestro CLI: `brew tap mobile-dev-inc/tap && brew install mobile-dev-inc/tap/maestro`
  2. Build development build: `npx eas build --profile development-simulator --platform ios --local`
  3. Install on simulator: `xcrun simctl install booted [path-to-built-app]`
  4. Ensure iOS simulator is booted (`xcrun simctl boot booted` or open Simulator.app)

  **Run E2E tests (single command -- starts Expo, seeds, runs Maestro, cleans up):**
  ```bash
  npm run test:e2e
  ```

  **Expected behavior:**
  1. Expo dev server starts automatically and script waits for Metro bundler to be ready
  2. Seed script populates AsyncStorage with test data
  3. Maestro runs 3 flows sequentially:
     - **habit-creation**: App opens to Today, navigates to guided builder, fills form, creates habit, sees it on Today
     - **habit-completion**: App opens to Today, taps habit card, evidence modal appears, skips, habit shows completed
     - **weekly-review**: App opens to Today, navigates to Review tab, opens review modal, fills inputs, selects law, submits
  4. Screenshots captured at checkpoints in `~/.maestro/tests/`
  5. All 3 flows report PASSED
  6. Expo dev server is automatically killed on completion (or on failure/Ctrl+C)

  **If flows fail:**
  - Check screenshots in `~/.maestro/tests/` for last captured state
  - Verify testIDs are correct: Maestro Studio (`maestro studio`) allows interactive element inspection
  - Common issues: keyboard blocking elements (add more `tapOn: point` dismissals), timing (add `waitForAnimationToEnd`), wrong testID spelling
  </action>
  <verify>User confirms all 3 Maestro flows pass, or reports specific failures for debugging</verify>
  <done>All 3 E2E flows (habit-creation, habit-completion, weekly-review) execute successfully via `npm run test:e2e` which automatically starts Expo, waits for ready, seeds data, runs Maestro, and cleans up. Screenshots captured at key checkpoints for visual confirmation.</done>
</task>

</tasks>

<verification>
- All 3 Maestro flows exist in `.maestro/flows/`
- Each flow uses testID-based selectors (not text-only)
- Each flow captures screenshots at key checkpoints via `takeScreenshot`
- All flows use `retryTapIfNoChange: false` on navigation/submit buttons
- `package.json` has `test:e2e` script that delegates to `scripts/run-e2e.sh`
- `scripts/run-e2e.sh` exists, is executable, and orchestrates: Expo start, wait-on, seed, Maestro run, cleanup
- `wait-on` installed as devDependency
- Flows execute against an automatically started Expo development build
- Human confirms all 3 flows pass on iOS simulator
</verification>

<success_criteria>
`npm run test:e2e` is a fully automated single command that starts Expo dev server, waits for Metro readiness, seeds AsyncStorage, runs all 3 Maestro flows, and kills Expo on exit. Habit creation flow completes guided builder and verifies new habit on Today screen. Habit completion flow taps a habit card and skips evidence. Weekly review flow fills the review form and submits. All 3 flows report PASSED with screenshots captured at checkpoints. No manual Expo start required.
</success_criteria>

<output>
After completion, create `.planning/phases/05-e2e-testing-maestro/05-02-SUMMARY.md`
</output>
