---
phase: 04-integration-tests-quality-gates
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/habits-context.test.tsx
autonomous: true

must_haves:
  truths:
    - "HabitsProvider CRUD cycle works: addHabit creates, updateHabit modifies, removeHabit deletes"
    - "All CRUD operations persist to AsyncStorage and survive simulated app restart"
    - "HabitsProvider hydrates habits, logs, and reviews from pre-seeded AsyncStorage on mount"
    - "completeHabit creates a log entry and increments streak, both persisted"
    - "uncompleteHabit removes today's log and decrements streak, both persisted"
  artifacts:
    - path: "lib/habits-context.test.tsx"
      provides: "HabitsProvider integration test suite"
  key_links:
    - from: "lib/habits-context.test.tsx"
      to: "lib/habits-context.tsx"
      via: "useHabits hook through test helper component"
      pattern: "useHabits\\(\\)"
    - from: "lib/habits-context.test.tsx"
      to: "AsyncStorage"
      via: "getItem/setItem assertions for persistence verification"
      pattern: "AsyncStorage\\.(getItem|setItem)"
---

<objective>
Test HabitsProvider CRUD operations with AsyncStorage persistence using TDD.

Purpose: HabitsProvider is the most complex provider (344 lines, 3 storage keys, 11 public methods). Testing its CRUD cycle with persistence verification ensures the core data layer is reliable. This directly satisfies phase success criterion 1.

Output: lib/habits-context.test.tsx with comprehensive integration tests covering CRUD, persistence, hydration, and completion/uncomplete flows.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/habits-context.tsx
@lib/test-utils.tsx
@jest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HabitsProvider CRUD and persistence integration tests</name>
  <files>lib/habits-context.test.tsx</files>
  <action>
Create lib/habits-context.test.tsx with a TestHabitsHook helper component that exposes useHabits() values via testID'd Text elements and Pressable buttons for triggering actions.

**Helper component pattern:**
```tsx
function TestHabitsHook({ onReady }: { onReady?: (ctx: ReturnType<typeof useHabits>) => void }) {
  const ctx = useHabits();
  // Expose values via testID Text elements
  // Expose actions via Pressable buttons with testIDs
}
```

Expose via testIDs:
- `loaded` (isLoaded), `habit-count` (habits.length), `log-count` (logs.length), `review-count` (reviews.length)
- For first habit: `habit-0-title`, `habit-0-streak`, `habit-0-current`, `habit-0-bestStreak`
- Action buttons: `add-habit`, `update-habit`, `remove-habit`, `complete-habit`, `uncomplete-habit`, `log-missed`, `increment-habit`, `add-review`

Use `render()` from `@/lib/test-utils` (wraps in all providers including HabitsProvider).

**Test cases (RED-GREEN for each group):**

1. **Hydration tests:**
   - Starts with empty habits when no storage data
   - Hydrates habits from pre-seeded AsyncStorage (pre-seed with `AsyncStorage.setItem('tinywins_habits', JSON.stringify([testHabit]))`)
   - Hydrates logs from pre-seeded AsyncStorage
   - Hydrates reviews from pre-seeded AsyncStorage
   - Handles corrupted storage data gracefully (pre-seed with invalid JSON)

2. **CRUD tests:**
   - addHabit: adds habit with generated id, zeroed current/streak/weekData, persists to AsyncStorage
   - updateHabit: modifies title, persists updated habit to AsyncStorage
   - removeHabit: removes habit by id, persists updated list to AsyncStorage

3. **Completion flow tests:**
   - completeHabit: sets current to goal, increments streak, creates "done" log, persists both habits and logs
   - uncompleteHabit: resets current to 0, decrements streak (min 0), removes today's done log, persists both
   - logMissed: resets streak to 0, creates "missed" log, persists both
   - incrementHabit: increments current by 1, updates weekData for current day

4. **App restart simulation:**
   - Add habit -> unmount -> remount -> habit still present (verify full persistence cycle)

**Important patterns:**
- `beforeEach(async () => { await AsyncStorage.clear(); })` to isolate tests
- Always `await waitFor(() => expect(screen.getByTestId('loaded')).toHaveTextContent('true'))` before assertions
- Use fake timers (`jest.useFakeTimers({ now: new Date('2026-02-16T12:00:00Z') })`) for deterministic date/time in log entries
- Verify persistence with dual assertions: check rendered testID AND `AsyncStorage.getItem()` value
- Use `act()` wrapper if needed for state updates triggered by button presses

**Test data factory:**
```typescript
const makeTestHabit = (overrides = {}) => ({
  id: 'test-habit-1',
  title: 'Morning Run',
  icon: 'fitness',
  iconColor: '#4ADE80',
  gradientColors: ['#4ADE80', '#22C55E'] as const,
  goal: 1,
  unit: 'times',
  frequency: 'Daily',
  current: 0,
  streak: 0,
  bestStreak: 0,
  weekData: [0, 0, 0, 0, 0, 0, 0],
  createdAt: Date.now(),
  ...overrides,
});
```

Target: ~15-20 test cases covering all CRUD operations and persistence verification.
  </action>
  <verify>
Run `npx jest lib/habits-context.test.tsx --verbose` and confirm all tests pass.
Run `npx jest lib/habits-context.test.tsx --coverage` and confirm habits-context.tsx coverage is above 80% for statements, branches, functions, and lines.
  </verify>
  <done>
HabitsProvider test file exists with passing tests that verify: (1) hydration from AsyncStorage, (2) all CRUD operations with persistence, (3) completion/uncomplete/missed flows with streak and log management, (4) app restart simulation showing data survives unmount/remount. Coverage of habits-context.tsx exceeds 80%.
  </done>
</task>

</tasks>

<verification>
1. `npx jest lib/habits-context.test.tsx --verbose` -- all tests pass
2. `npx jest lib/habits-context.test.tsx --coverage` -- habits-context.tsx coverage above 80% for all 4 metrics
3. `npx jest --testPathPattern="habits-context"` -- no regressions in existing test suite
</verification>

<success_criteria>
- lib/habits-context.test.tsx exists with 15+ passing test cases
- HabitsProvider CRUD cycle (create, read, update, delete) verified with AsyncStorage persistence
- Completion/uncomplete/missed flows verified with streak and log assertions
- Hydration from pre-seeded AsyncStorage verified
- App restart simulation passes (data survives unmount/remount)
- habits-context.tsx coverage exceeds 80% for all 4 metrics
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-tests-quality-gates/04-01-SUMMARY.md`
</output>
