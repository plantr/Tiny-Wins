---
phase: 04-integration-tests-quality-gates
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/habits-context.tsx
  - lib/habits-context.test.tsx
  - jest.config.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "habits-context.tsx branches coverage is at or above 80%"
    - "jest.config.js enforces 80% branches threshold for habits-context.tsx"
    - "npx jest exits cleanly (code 0) with all thresholds met"
    - "All 188+ existing tests still pass (no regressions)"
  artifacts:
    - path: "lib/habits-context.tsx"
      provides: "Clean provider with no dead code"
      contains: "No persistHabits, persistLogs, or persistReviews functions"
    - path: "lib/habits-context.test.tsx"
      provides: "Test for useHabits outside provider error branch"
      contains: "useHabits must be used within a HabitsProvider"
    - path: "jest.config.js"
      provides: "80% branches threshold for habits-context"
      contains: "branches: 80"
  key_links:
    - from: "jest.config.js"
      to: "lib/habits-context.tsx"
      via: "per-path coverage threshold"
      pattern: "habits-context.*branches.*80"
---

<objective>
Close the single verification gap from Phase 04: habits-context.tsx branches coverage at 77.41% must reach 80%.

Purpose: The phase success criterion requires "Coverage threshold is 80% and npx jest fails if any file drops below it." Three of four providers meet this, but habits-context branches is at 77.41% with a 75% threshold. This gap closure removes dead code (3 unused useCallback functions: persistHabits, persistLogs, persistReviews) that create uncoverable branches, adds a test for the useHabits() error branch (line 340), and raises the threshold to 80%.

Output: habits-context.tsx branches >= 80%, jest.config.js enforcing 80%, all tests passing.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-tests-quality-gates/04-VERIFICATION.md
@.planning/phases/04-integration-tests-quality-gates/04-03-SUMMARY.md
@lib/habits-context.tsx
@lib/habits-context.test.tsx
@jest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead code and add missing branch test</name>
  <files>lib/habits-context.tsx, lib/habits-context.test.tsx</files>
  <action>
    **Part A: Remove dead useCallback functions from habits-context.tsx**

    Remove the three unused `useCallback` functions at lines 123-136:
    - `persistHabits` (lines 123-126)
    - `persistLogs` (lines 128-131)
    - `persistReviews` (lines 133-136)

    These functions are defined but never called anywhere in the codebase. The actual persistence is done inline within each action function (addHabit, updateHabit, removeHabit, etc. all call `AsyncStorage.setItem` directly). Removing them eliminates 6 uncoverable branch lines (124-125, 129-130, 134-135).

    Verify no imports or references exist elsewhere (confirmed: only in CONVENTIONS.md documentation).

    **Part B: Add useHabits() outside-provider error test to habits-context.test.tsx**

    Add a test at the top of the describe block (before "Hydration tests") that verifies `useHabits()` throws when called outside a `HabitsProvider`. This covers the error branch at line 340.

    Test pattern:
    ```typescript
    describe('useHabits guard', () => {
      it('throws when used outside HabitsProvider', () => {
        // Suppress React error boundary console output
        const consoleSpy = jest.spyOn(console, 'error').mockImplementation(() => {});

        function BadComponent() {
          useHabits();
          return null;
        }

        // Use RNTL render WITHOUT the custom wrapper (no providers)
        const RNTLRender = require('@testing-library/react-native').render;
        expect(() => RNTLRender(<BadComponent />)).toThrow(
          'useHabits must be used within a HabitsProvider'
        );

        consoleSpy.mockRestore();
      });
    });
    ```

    Key: Use the raw RNTL render (not the custom test-utils render that wraps with providers). Import it directly from @testing-library/react-native to bypass the provider wrapper.
  </action>
  <verify>
    Run: `cd "/Users/robert.plant/Development/Tiny Wins" && npx jest lib/habits-context.test.tsx --coverage --collectCoverageFrom='lib/habits-context.tsx' --silent 2>&1 | grep -E "habits-context|Tests:|Suites:"`

    Expected:
    - All tests pass (19 existing + 1 new = 20 tests)
    - habits-context.tsx branches coverage >= 80%
    - No "not met" in output
  </verify>
  <done>
    habits-context.tsx has no dead persist functions, useHabits error branch is tested, and branches coverage is at or above 80%.
  </done>
</task>

<task type="auto">
  <name>Task 2: Raise habits-context branches threshold to 80%</name>
  <files>jest.config.js</files>
  <action>
    Update jest.config.js to raise the habits-context.tsx branches threshold from 75 to 80.

    Change line 79 from:
    ```javascript
    branches: 75,
    ```
    to:
    ```javascript
    branches: 80,
    ```

    Also remove the comment on line 77 that says "Target: 80% branches -- needs additional tests (current: 77.41%)" since the target is now met. Replace with a clean comment matching the other provider entries:
    ```javascript
    // Providers (Phase 4) -- 80% threshold
    './lib/habits-context.tsx': {
      branches: 80,
    ```

    Do NOT change any other thresholds. All other provider files already have branches: 80.
  </action>
  <verify>
    Run full test suite: `cd "/Users/robert.plant/Development/Tiny Wins" && npx jest --silent 2>&1 | tail -5`

    Expected:
    - Test Suites: all passed (27+)
    - Tests: all passed (189+)
    - Exit code: 0
    - No "not met" threshold warnings

    Also verify threshold is set: `grep -A4 "habits-context" "/Users/robert.plant/Development/Tiny Wins/jest.config.js" | grep branches`
    Expected: `branches: 80,`
  </verify>
  <done>
    jest.config.js enforces 80% branches threshold for habits-context.tsx, and npx jest exits cleanly with all thresholds met. All 4 Phase 4 providers now have uniform 80% thresholds across all metrics.
  </done>
</task>

</tasks>

<verification>
1. `npx jest --coverage --collectCoverageFrom='lib/habits-context.tsx' --silent` shows branches >= 80%
2. `npx jest --silent` exits with code 0, all tests pass, no threshold violations
3. `grep "branches: 80" jest.config.js` shows 4 entries (one per provider)
4. All 4 provider files in jest.config.js have identical 80% thresholds across all metrics
</verification>

<success_criteria>
- habits-context.tsx branches coverage >= 80%
- jest.config.js has branches: 80 for habits-context.tsx
- npx jest exits cleanly (code 0) with no threshold violations
- All existing tests still pass (no regressions)
- Dead code (persistHabits, persistLogs, persistReviews) removed from habits-context.tsx
- useHabits() outside-provider error branch tested
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-tests-quality-gates/04-04-SUMMARY.md`
</output>
