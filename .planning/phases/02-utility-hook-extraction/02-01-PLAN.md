---
phase: 02-utility-hook-extraction
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/utils/time.ts
  - lib/utils/time.test.ts
  - lib/utils/date.ts
  - lib/utils/date.test.ts
  - app/(tabs)/index.tsx
  - app/(tabs)/review.tsx
  - lib/habits-context.tsx
  - jest.config.js
autonomous: true

must_haves:
  truths:
    - "formatTime('00:00') returns '12:00 am' (midnight edge case)"
    - "formatTime('12:00') returns '12:00 pm' (noon edge case)"
    - "formatTime('13:30') returns '1:30 pm' (standard PM conversion)"
    - "getTodayStr() returns YYYY-MM-DD format with zero-padded month and day"
    - "getWeekStartDate() returns Monday for default week start day"
    - "getWeekStartDate() respects weekStartDay parameter (e.g., Sunday start returns Sunday)"
    - "getWeekStartDate() handles week-start-day correctly across all days of the week"
    - "index.tsx imports formatTime from @/lib/utils/time instead of defining it inline"
    - "habits-context.tsx imports getTodayStr from @/lib/utils/date instead of defining it inline"
    - "index.tsx imports getTodayStr from @/lib/utils/date instead of defining it inline"
    - "review.tsx imports getWeekStartDate from @/lib/utils/date instead of defining inline getWeekStart"
  artifacts:
    - path: "lib/utils/time.ts"
      provides: "formatTime pure function"
      exports: ["formatTime"]
    - path: "lib/utils/time.test.ts"
      provides: "Tests for formatTime covering edge cases"
      min_lines: 25
    - path: "lib/utils/date.ts"
      provides: "getTodayStr, getWeekStartDate pure functions"
      exports: ["getTodayStr", "getWeekStartDate"]
    - path: "lib/utils/date.test.ts"
      provides: "Tests for getTodayStr and getWeekStartDate with fake timers"
      min_lines: 40
  key_links:
    - from: "app/(tabs)/index.tsx"
      to: "lib/utils/time.ts"
      via: "import { formatTime }"
      pattern: "import.*formatTime.*from.*@/lib/utils/time"
    - from: "app/(tabs)/index.tsx"
      to: "lib/utils/date.ts"
      via: "import { getTodayStr }"
      pattern: "import.*getTodayStr.*from.*@/lib/utils/date"
    - from: "lib/habits-context.tsx"
      to: "lib/utils/date.ts"
      via: "import { getTodayStr }"
      pattern: "import.*getTodayStr.*from.*@/lib/utils/date"
    - from: "app/(tabs)/review.tsx"
      to: "lib/utils/date.ts"
      via: "import { getWeekStartDate }"
      pattern: "import.*getWeekStartDate.*from.*@/lib/utils/date"
---

<objective>
Extract time formatting and date helper utilities from monolithic screen files into shared, tested modules.

Purpose: Deduplicate getTodayStr (duplicated in index.tsx and habits-context.tsx), make formatTime testable by extracting to lib/utils/, and extract getWeekStartDate (from review.tsx) with parameterized week-start-day support. Tests written BEFORE extraction to capture current inline behavior (per user decision). One commit per utility (per user decision).

Output: lib/utils/time.ts, lib/utils/time.test.ts, lib/utils/date.ts, lib/utils/date.test.ts with inline code replaced by imports in source files. getWeekStartDate supports week-start-day setting per Success Criteria 3.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure-setup/01-01-SUMMARY.md
@.planning/phases/01-test-infrastructure-setup/01-03-SUMMARY.md
@jest.config.js
@lib/test-utils.tsx
@app/(tabs)/index.tsx
@app/(tabs)/review.tsx
@lib/habits-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD extract formatTime to lib/utils/time.ts</name>
  <files>lib/utils/time.ts, lib/utils/time.test.ts, app/(tabs)/index.tsx, jest.config.js</files>
  <action>
**RED phase — Write tests first (per user decision: "Write tests for current inline behavior BEFORE extracting"):**

1. Create `lib/utils/` directory if it doesn't exist.

2. Create `lib/utils/time.ts` with the **exact** current implementation from `app/(tabs)/index.tsx` lines 995-1001:
```typescript
/**
 * Converts 24-hour time string (HH:MM) to 12-hour format with AM/PM.
 * Handles midnight (00:xx -> 12:xx am) and noon (12:xx -> 12:xx pm).
 */
export function formatTime(time24: string): string {
  const [hStr, mStr] = time24.split(":");
  const h = parseInt(hStr, 10);
  const ampm = h < 12 ? "am" : "pm";
  const h12 = h % 12 === 0 ? 12 : h % 12;
  return `${h12}:${mStr} ${ampm}`;
}
```

3. Create `lib/utils/time.test.ts` with comprehensive tests:
- Morning hours: `formatTime('07:30')` -> `'7:30 am'`, `formatTime('09:00')` -> `'9:00 am'`
- Afternoon/evening: `formatTime('13:30')` -> `'1:30 pm'`, `formatTime('23:45')` -> `'11:45 pm'`
- Midnight edge case: `formatTime('00:00')` -> `'12:00 am'`, `formatTime('00:30')` -> `'12:30 am'`
- Noon edge case: `formatTime('12:00')` -> `'12:00 pm'`, `formatTime('12:30')` -> `'12:30 pm'`
- Minute padding preserved: `formatTime('07:05')` -> `'7:05 am'`, `formatTime('14:09')` -> `'2:09 pm'`
- Boundary: `formatTime('11:59')` -> `'11:59 am'` (last AM minute)

4. Run tests: `npx jest lib/utils/time.test.ts` — must pass (GREEN, since we're extracting existing code).

**EXTRACT phase — Replace inline code with import:**

5. In `app/(tabs)/index.tsx`:
   - Add import: `import { formatTime } from "@/lib/utils/time";`
   - Comment out the inline `formatTime` function at lines 995-1001 with `// EXTRACTED to @/lib/utils/time.ts` prefix
   - Do NOT remove any other code

6. Run full test suite: `npx jest` — all existing tests must still pass.

7. Add per-path 70% coverage threshold for `lib/utils/time.ts` in `jest.config.js` coverageThreshold section:
```javascript
'./lib/utils/time.ts': {
  branches: 70,
  functions: 70,
  lines: 70,
  statements: 70,
},
```

8. Run `npx jest --coverage` to verify coverage threshold is met.

9. Commit: `feat(02-01): extract formatTime to lib/utils/time.ts with tests`
  </action>
  <verify>
- `npx jest lib/utils/time.test.ts --verbose` passes all test cases
- `npx jest --coverage` passes (including new per-path threshold)
- `grep -n "import.*formatTime.*from.*@/lib/utils/time" app/\(tabs\)/index.tsx` finds the import
- `grep -n "EXTRACTED" app/\(tabs\)/index.tsx` finds commented-out old code
- Run `npx expo start` and spot-check time display on Today screen (per user decision: verify app after each extraction)
  </verify>
  <done>formatTime extracted to lib/utils/time.ts with 6+ test cases covering midnight, noon, AM, PM, and minute padding. index.tsx imports from shared module. Old inline code commented out. Per-path 70% coverage threshold active.</done>
</task>

<task type="auto">
  <name>Task 2: TDD extract getTodayStr to lib/utils/date.ts</name>
  <files>lib/utils/date.ts, lib/utils/date.test.ts, app/(tabs)/index.tsx, lib/habits-context.tsx, jest.config.js</files>
  <action>
**RED phase — Write tests first:**

1. Create `lib/utils/date.ts` with the **exact** current implementation from `app/(tabs)/index.tsx` lines 52-55 (identical to `lib/habits-context.tsx` lines 89-92):
```typescript
/**
 * Returns today's date as YYYY-MM-DD string in local timezone.
 * Zero-pads month and day to always produce 10-character string.
 */
export function getTodayStr(): string {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
}
```

2. Create `lib/utils/date.test.ts` with deterministic tests using fake timers:
- Setup: `jest.useFakeTimers()` in beforeEach, `jest.useRealTimers()` in afterEach
- Format check: Set time to 2026-02-16T10:30:00, assert matches `/^\d{4}-\d{2}-\d{2}$/`
- Zero-padding month: Set time to 2026-01-05T10:00:00, assert returns `'2026-01-05'`
- Zero-padding day: Set time to 2026-12-03T10:00:00, assert returns `'2026-12-03'`
- Double-digit month/day: Set time to 2026-11-25T10:00:00, assert returns `'2026-11-25'`
- Year boundary: Set time to 2025-12-31T23:59:00, assert returns `'2025-12-31'`
- New year: Set time to 2026-01-01T00:01:00, assert returns `'2026-01-01'`

3. Run tests: `npx jest lib/utils/date.test.ts` — must pass.

**EXTRACT phase — Replace BOTH inline copies with import:**

4. In `app/(tabs)/index.tsx`:
   - Add import: `import { getTodayStr } from "@/lib/utils/date";`
   - Comment out the inline `getTodayStr` function at lines 52-55 with `// EXTRACTED to @/lib/utils/date.ts` prefix

5. In `lib/habits-context.tsx`:
   - Add import: `import { getTodayStr } from "@/lib/utils/date";`
   - Comment out the inline `getTodayStr` function at lines 89-92 with `// EXTRACTED to @/lib/utils/date.ts` prefix

6. Run full test suite: `npx jest` — all tests must still pass.

7. Add per-path 70% coverage threshold for `lib/utils/date.ts` in `jest.config.js`.

8. Run `npx jest --coverage` to verify.

9. Commit: `feat(02-01): extract getTodayStr to lib/utils/date.ts with tests`
  </action>
  <verify>
- `npx jest lib/utils/date.test.ts --verbose` passes all test cases
- `npx jest --coverage` passes (including new per-path threshold)
- `grep -n "import.*getTodayStr.*from.*@/lib/utils/date" app/\(tabs\)/index.tsx` finds the import
- `grep -n "import.*getTodayStr.*from.*@/lib/utils/date" lib/habits-context.tsx` finds the import
- Both old inline copies are commented out
- Run `npx expo start` and spot-check date-based features (habit log dates, day selector) (per user decision: verify app after each extraction)
  </verify>
  <done>getTodayStr extracted to lib/utils/date.ts with 6+ test cases using fake timers. Both index.tsx and habits-context.tsx import from shared module (deduplication complete). Old inline code commented out in both files. Per-path 70% coverage threshold active.</done>
</task>

<task type="auto">
  <name>Task 3: TDD extract getWeekStartDate to lib/utils/date.ts</name>
  <files>lib/utils/date.ts, lib/utils/date.test.ts, app/(tabs)/review.tsx</files>
  <action>
**RED phase — Write tests first (per user decision):**

1. Add `getWeekStartDate` to `lib/utils/date.ts`. This is extracted from `app/(tabs)/review.tsx` lines 26-32, but parameterized to accept a week start day (to keep it pure and support the user's week-start-day setting per Success Criteria 3):

```typescript
/**
 * Day name type matching the WeekStartDay type from theme-context.
 */
export type DayName = "Sunday" | "Monday" | "Tuesday" | "Wednesday" | "Thursday" | "Friday" | "Saturday";

/**
 * Maps day names to JS Date.getDay() indices (0=Sunday, 6=Saturday).
 */
const DAY_INDEX: Record<DayName, number> = {
  Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3,
  Thursday: 4, Friday: 5, Saturday: 6,
};

/**
 * Returns the start of the current week as a YYYY-MM-DD string,
 * based on the given week start day preference.
 *
 * @param weekStartDay - Which day the week starts on (default: "Monday")
 * @param now - Optional date to calculate from (defaults to new Date(), supports testing)
 * @returns YYYY-MM-DD string for the week's start date
 *
 * @example
 * // On a Wednesday 2026-02-18:
 * getWeekStartDate("Monday") // "2026-02-16"
 * getWeekStartDate("Sunday") // "2026-02-15"
 */
export function getWeekStartDate(weekStartDay: DayName = "Monday", now?: Date): string {
  const d = now ? new Date(now) : new Date();
  const currentDay = d.getDay(); // 0=Sun, 6=Sat
  const startIdx = DAY_INDEX[weekStartDay];
  let diff = currentDay - startIdx;
  if (diff < 0) diff += 7;
  d.setDate(d.getDate() - diff);
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
}
```

2. Add tests to `lib/utils/date.test.ts` for `getWeekStartDate`:

**Default Monday start:**
- Wednesday 2026-02-18 -> "2026-02-16" (Monday)
- Monday 2026-02-16 -> "2026-02-16" (already Monday)
- Sunday 2026-02-22 -> "2026-02-16" (previous Monday)
- Saturday 2026-02-21 -> "2026-02-16" (previous Monday)

**Sunday start:**
- Wednesday 2026-02-18 -> "2026-02-15" (Sunday)
- Sunday 2026-02-15 -> "2026-02-15" (already Sunday)
- Saturday 2026-02-21 -> "2026-02-15" (previous Sunday)

**Other start days:**
- Thursday start, on a Wednesday 2026-02-18 -> "2026-02-12" (previous Thursday)
- Saturday start, on a Saturday 2026-02-21 -> "2026-02-21" (already Saturday)

**Cross month boundary:**
- Monday start, on Tuesday 2026-03-03 -> "2026-03-02" (Monday)
- Monday start, on Monday 2026-03-02 -> "2026-03-02"
- Sunday start, on Monday 2026-03-02 -> "2026-03-01"

All tests use `jest.setSystemTime()` for deterministic dates.

3. Run tests: `npx jest lib/utils/date.test.ts` — must pass.

**EXTRACT phase — Replace inline getWeekStart in review.tsx:**

4. In `app/(tabs)/review.tsx`:
   - Add import: `import { getWeekStartDate } from "@/lib/utils/date";`
   - Comment out the inline `getWeekStart` function at lines 26-32 with `// EXTRACTED to @/lib/utils/date.ts` prefix
   - Replace usage at line 47: change `const weekStart = getWeekStart();` to `const weekStart = getWeekStartDate();` (uses default "Monday" which matches the hardcoded behavior)

5. Run full test suite: `npx jest` — all tests must still pass.

6. Commit: `feat(02-01): extract getWeekStartDate to lib/utils/date.ts with tests`
  </action>
  <verify>
- `npx jest lib/utils/date.test.ts --verbose` passes all test cases (including new getWeekStartDate tests)
- `npx jest` full suite passes
- `grep -n "import.*getWeekStartDate.*from.*@/lib/utils/date" app/\(tabs\)/review.tsx` finds the import
- `grep -n "EXTRACTED" app/\(tabs\)/review.tsx` finds commented-out old code
- Run `npx expo start` and spot-check Review tab (week start display, weekly logs filtering) (per user decision: verify app after each extraction)
  </verify>
  <done>getWeekStartDate extracted to lib/utils/date.ts with 10+ test cases covering Monday start (default), Sunday start, other start days, same-day edge cases, and cross-month boundaries. Parameterized with weekStartDay to support week-start-day setting per Success Criteria 3. review.tsx imports from shared module. Old inline code commented out.</done>
</task>

</tasks>

<verification>
After all three tasks:
1. `npx jest` — all tests pass (existing smoke test + new utility tests)
2. `npx jest --coverage` — per-path 70% thresholds met for time.ts and date.ts
3. `ls lib/utils/` — contains time.ts, time.test.ts, date.ts, date.test.ts
4. No duplicate `formatTime`, `getTodayStr`, or `getWeekStart` function definitions remain uncommented in source files
5. `getWeekStartDate` accepts weekStartDay parameter and handles all 7 days correctly
6. Verify app runs: `npx expo start` and spot-check time display, date-based features, and Review tab week display (per user decision: verify app after each extraction)
</verification>

<success_criteria>
- formatTime, getTodayStr, and getWeekStartDate live in lib/utils/ with full test suites
- getTodayStr deduplication eliminates copy in both index.tsx and habits-context.tsx
- getWeekStartDate supports week-start-day parameter, handling all 7 days correctly (addresses Success Criteria 3)
- getWeekStart in review.tsx replaced with shared import
- All existing tests continue to pass
- Per-path 70% coverage thresholds enforced on both new utility files
- 3 atomic commits (one per utility) enable individual rollback
</success_criteria>

<output>
After completion, create `.planning/phases/02-utility-hook-extraction/02-01-SUMMARY.md`
</output>
