---
phase: 02-utility-hook-extraction
plan: 03
type: tdd
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - lib/utils/id.ts
  - lib/utils/id.test.ts
  - lib/habits-context.tsx
  - app/(tabs)/index.tsx
  - app/guided-builder.tsx
  - app/edit-habit.tsx
  - app/add-habit.tsx
  - jest.config.js
autonomous: true

must_haves:
  truths:
    - "generateId returns a string matching /^\\d+[a-z0-9]+$/ pattern"
    - "generateId returns unique values on consecutive calls"
    - "habits-context.tsx imports generateId from @/lib/utils/id"
    - "No commented-out EXTRACTED code remains in any source file"
    - "All utility tests pass with coverage thresholds enforced"
  artifacts:
    - path: "lib/utils/id.ts"
      provides: "generateId pure function"
      exports: ["generateId"]
    - path: "lib/utils/id.test.ts"
      provides: "Tests for generateId covering format and uniqueness"
      min_lines: 15
  key_links:
    - from: "lib/habits-context.tsx"
      to: "lib/utils/id.ts"
      via: "import { generateId }"
      pattern: "import.*generateId.*from.*@/lib/utils/id"
---

<objective>
Extract ID generation to a shared utility and clean up all commented-out code from Phase 2 extractions.

Purpose: Complete the utility extraction suite by moving generateId to lib/utils/id.ts with tests, then remove all commented-out inline code left as safety nets in prior plans (per user decision: "Keep commented-out inline code for one commit as safety net, remove in follow-up cleanup"). This plan depends on 02-01 and 02-02 being complete.

Output: lib/utils/id.ts with tests, all source files cleaned of commented-out extraction remnants, final coverage thresholds updated.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-utility-hook-extraction/02-01-SUMMARY.md
@.planning/phases/02-utility-hook-extraction/02-02-SUMMARY.md
@lib/habits-context.tsx
@jest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD extract generateId to lib/utils/id.ts</name>
  <files>lib/utils/id.ts, lib/utils/id.test.ts, lib/habits-context.tsx, jest.config.js</files>
  <action>
**RED phase — Write tests first (per user decision):**

1. Create `lib/utils/id.ts` with the **exact** current implementation from `lib/habits-context.tsx` lines 94-96:
```typescript
/**
 * Generates a unique client-side ID using timestamp + random alphanumeric suffix.
 * IDs are client-only (no server collision concerns). Format: {timestamp}{random9chars}
 */
export function generateId(): string {
  return Date.now().toString() + Math.random().toString(36).substr(2, 9);
}
```

2. Create `lib/utils/id.test.ts` with tests:
- **Format test:** `generateId()` returns a string (not undefined/null)
- **Length test:** `generateId()` returns a string of at least 13 characters (timestamp portion alone is 13 digits)
- **Pattern test:** `generateId()` matches `/^\d+[a-z0-9]+$/` (digits followed by alphanumeric)
- **Uniqueness test:** Generate 100 IDs, put in a Set, verify Set size equals 100 (all unique)
- **Type test:** `typeof generateId()` is `'string'`

3. Run tests: `npx jest lib/utils/id.test.ts` — must pass.

**EXTRACT phase:**

4. In `lib/habits-context.tsx`:
   - Add import: `import { generateId } from "@/lib/utils/id";`
   - Comment out the inline `generateId` function at lines 94-96 with `// EXTRACTED to @/lib/utils/id.ts` prefix

5. Run full test suite: `npx jest` — all tests must pass.

6. Add per-path 70% coverage threshold for `lib/utils/id.ts` in `jest.config.js`.

7. Commit: `feat(02-03): extract generateId to lib/utils/id.ts with tests`
  </action>
  <verify>
- `npx jest lib/utils/id.test.ts --verbose` passes all test cases
- `npx jest --coverage` passes with per-path threshold for id.ts
- `grep -n "import.*generateId.*from.*@/lib/utils/id" lib/habits-context.tsx` finds the import
  </verify>
  <done>generateId extracted to lib/utils/id.ts with 5+ test cases covering format, length, pattern, uniqueness, and type. habits-context.tsx imports from shared module. Per-path 70% coverage threshold active.</done>
</task>

<task type="auto">
  <name>Task 2: Clean up all commented-out extraction code and raise global coverage floor</name>
  <files>app/(tabs)/index.tsx, app/guided-builder.tsx, app/edit-habit.tsx, app/add-habit.tsx, lib/habits-context.tsx, jest.config.js</files>
  <action>
This task removes all `// EXTRACTED` commented-out code from plans 02-01, 02-02, and Task 1 of this plan. Per user decision: "Keep commented-out inline code for one commit as safety net, remove in follow-up cleanup."

**Cleanup across all files:**

1. In `app/(tabs)/index.tsx`: Remove commented-out `formatTime` function and commented-out `getTodayStr` function (both marked with `// EXTRACTED`). Keep the imports.

2. In `lib/habits-context.tsx`: Remove commented-out `getTodayStr` function and commented-out `generateId` function (both marked with `// EXTRACTED`). Keep the imports.

3. In `app/guided-builder.tsx`: Remove commented-out `DAYS_LIST` constant and commented-out `buildCustomFrequency` closure (marked with `// EXTRACTED`). Keep the imports.

4. In `app/edit-habit.tsx`: Remove commented-out `DAYS` constant, commented-out `parseCustomFrequency` closure, and commented-out `buildCustomFrequency` closure (all marked with `// EXTRACTED`). Keep the imports.

5. In `app/add-habit.tsx`: Remove commented-out `DAYS` constant and commented-out `buildCustomFrequency` closure (marked with `// EXTRACTED`). Keep the imports.

**Raise global coverage floor:**

6. In `jest.config.js`, raise the global coverage floor to account for new utility test coverage. The exact values should be set to just below the current coverage levels after running `npx jest --coverage` (same strategy as Phase 1 plan 03 — set floor below current to catch regressions). Expected increase: global lines should be higher now with 4 new fully-tested utility files.

7. Run `npx jest --coverage` — must pass with updated thresholds.

8. Run `npx jest` — all tests pass, zero commented-out EXTRACTED code remains.

9. Verify no `// EXTRACTED` comments remain: `grep -rn "EXTRACTED" app/ lib/` should return empty.

10. Commit: `refactor(02-03): clean up commented-out extraction code and raise coverage floor`
  </action>
  <verify>
- `grep -rn "EXTRACTED" app/ lib/` returns no results
- `npx jest` passes all tests
- `npx jest --coverage` passes with raised global floor
- No inline function definitions for formatTime, getTodayStr, generateId, buildCustomFrequency, or parseCustomFrequency remain in screen/context files (only imports and call sites)
  </verify>
  <done>All commented-out extraction code removed from 5 source files. Global coverage floor raised to reflect new test coverage from utility extraction. Codebase is clean — no EXTRACTED comments remain. All 4 utility modules (time, date, frequency, id) are the single source of truth.</done>
</task>

</tasks>

<verification>
After both tasks — final Phase 2 verification:
1. `npx jest` — all tests pass (smoke test + time + date + frequency + id)
2. `npx jest --coverage` — all per-path 70% thresholds met, raised global floor enforced
3. `ls lib/utils/` — contains time.ts, time.test.ts, date.ts, date.test.ts, frequency.ts, frequency.test.ts, id.ts, id.test.ts (8 files)
4. `grep -rn "EXTRACTED" app/ lib/` — returns empty (all cleanup done)
5. No duplicate utility function definitions remain uncommented in any source file
6. Verify app runs: `npx expo start` and do final spot-check of all screens (per user decision)
</verification>

<success_criteria>
- generateId lives in lib/utils/id.ts with test suite
- All 5 source files cleaned of commented-out extraction code
- Global coverage floor raised to reflect expanded test coverage
- Complete Phase 2 utility suite: time.ts, date.ts, frequency.ts, id.ts — all tested, all enforced at 70%
- 2 atomic commits: one for ID extraction, one for cleanup + threshold raise
</success_criteria>

<output>
After completion, create `.planning/phases/02-utility-hook-extraction/02-03-SUMMARY.md`
</output>
