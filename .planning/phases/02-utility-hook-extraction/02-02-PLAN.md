---
phase: 02-utility-hook-extraction
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/utils/frequency.ts
  - lib/utils/frequency.test.ts
  - app/guided-builder.tsx
  - app/edit-habit.tsx
  - app/add-habit.tsx
  - jest.config.js
autonomous: true

must_haves:
  truths:
    - "buildCustomFrequency(1, 'days', []) returns 'Daily'"
    - "buildCustomFrequency(1, 'weeks', ['Mon', 'Wed', 'Fri']) returns 'Weekly on Mon, Wed, Fri'"
    - "buildCustomFrequency(2, 'weeks', ['Tue', 'Thu']) returns 'Every 2 weeks on Tue, Thu'"
    - "parseCustomFrequency('Daily') returns { interval: '1', period: 'days', days: [] }"
    - "parseCustomFrequency round-trips with buildCustomFrequency for all frequency patterns"
    - "guided-builder.tsx imports buildCustomFrequency from @/lib/utils/frequency"
    - "edit-habit.tsx imports both buildCustomFrequency and parseCustomFrequency from @/lib/utils/frequency"
    - "add-habit.tsx imports buildCustomFrequency from @/lib/utils/frequency"
  artifacts:
    - path: "lib/utils/frequency.ts"
      provides: "buildCustomFrequency, parseCustomFrequency, DAYS_LIST constant"
      exports: ["buildCustomFrequency", "parseCustomFrequency", "DAYS_LIST"]
    - path: "lib/utils/frequency.test.ts"
      provides: "Tests for frequency build/parse covering all patterns and round-trips"
      min_lines: 50
  key_links:
    - from: "app/guided-builder.tsx"
      to: "lib/utils/frequency.ts"
      via: "import { buildCustomFrequency, DAYS_LIST }"
      pattern: "import.*buildCustomFrequency.*from.*@/lib/utils/frequency"
    - from: "app/edit-habit.tsx"
      to: "lib/utils/frequency.ts"
      via: "import { buildCustomFrequency, parseCustomFrequency, DAYS_LIST }"
      pattern: "import.*parseCustomFrequency.*from.*@/lib/utils/frequency"
    - from: "app/add-habit.tsx"
      to: "lib/utils/frequency.ts"
      via: "import { buildCustomFrequency, DAYS_LIST }"
      pattern: "import.*buildCustomFrequency.*from.*@/lib/utils/frequency"
---

<objective>
Extract frequency building and parsing utilities from three screen files into a shared, tested module.

Purpose: Deduplicate buildCustomFrequency (duplicated in guided-builder.tsx, edit-habit.tsx, AND add-habit.tsx) and extract parseCustomFrequency (in edit-habit.tsx) into a shared lib/utils/frequency.ts. Also deduplicates the DAYS_LIST/DAYS constant. Tests written BEFORE extraction (per user decision). One commit per utility extraction (per user decision).

Output: lib/utils/frequency.ts and lib/utils/frequency.test.ts with all 3 screen files importing from shared module.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/guided-builder.tsx
@app/edit-habit.tsx
@app/add-habit.tsx
@jest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD extract buildCustomFrequency and parseCustomFrequency to lib/utils/frequency.ts</name>
  <files>lib/utils/frequency.ts, lib/utils/frequency.test.ts, jest.config.js</files>
  <action>
**RED phase — Write tests first (per user decision):**

Note: The current inline implementations use closure variables (customInterval, customPeriod, customDays). The extracted version must accept these as parameters instead. The function signatures change from closures to pure functions, but the logic must remain identical.

1. Create `lib/utils/frequency.ts` with parameterized pure functions extracted from the closures:

```typescript
/**
 * Canonical day ordering for frequency display.
 * Used across guided-builder, edit-habit, and add-habit screens.
 */
export const DAYS_LIST = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

/**
 * Builds a human-readable custom frequency string from interval, period, and selected days.
 *
 * @param interval - Numeric interval as string (e.g., "1", "2", "3")
 * @param period - Either "days" or "weeks"
 * @param days - Selected day abbreviations (e.g., ["Mon", "Wed", "Fri"])
 * @returns Formatted frequency string (e.g., "Daily", "Weekly on Mon, Wed", "Every 2 weeks on Tue, Thu")
 */
export function buildCustomFrequency(
  interval: string,
  period: "days" | "weeks",
  days: string[]
): string {
  const n = parseInt(interval) || 1;
  if (period === "weeks" && days.length > 0) {
    const sorted = DAYS_LIST.filter((d) => days.includes(d));
    if (n === 1) return `Weekly on ${sorted.join(", ")}`;
    return `Every ${n} weeks on ${sorted.join(", ")}`;
  }
  if (n === 1) return period === "days" ? "Daily" : "Weekly";
  return `Every ${n} ${period}`;
}

/**
 * Parses a custom frequency string back into its constituent parts.
 * Inverse of buildCustomFrequency for round-trip editing.
 *
 * @param f - Frequency string (e.g., "Weekly on Mon, Wed", "Every 2 days")
 * @returns Object with interval, period, and days array
 */
export function parseCustomFrequency(f: string): {
  interval: string;
  period: "days" | "weeks";
  days: string[];
} {
  let interval = "1";
  let period: "days" | "weeks" = "weeks";
  let days: string[] = [];
  if (f.startsWith("Every ")) {
    const parts = f.replace("Every ", "").split(" ");
    interval = parts[0] || "1";
    if (parts[1]?.startsWith("day")) period = "days";
    else period = "weeks";
    const onIdx = f.indexOf(" on ");
    if (onIdx !== -1) {
      days = f.substring(onIdx + 4).split(", ").map((d) => d.trim()).filter(Boolean);
    }
  } else if (f.startsWith("Weekly on ")) {
    days = f.replace("Weekly on ", "").split(", ").map((d) => d.trim()).filter(Boolean);
  }
  return { interval, period, days };
}
```

2. Create `lib/utils/frequency.test.ts` with comprehensive tests:

**buildCustomFrequency tests:**
- Daily: `buildCustomFrequency("1", "days", [])` -> `"Daily"`
- Weekly (no days): `buildCustomFrequency("1", "weeks", [])` -> `"Weekly"`
- Weekly with days: `buildCustomFrequency("1", "weeks", ["Mon", "Wed", "Fri"])` -> `"Weekly on Mon, Wed, Fri"`
- Every N days: `buildCustomFrequency("3", "days", [])` -> `"Every 3 days"`
- Every N weeks with days: `buildCustomFrequency("2", "weeks", ["Tue", "Thu"])` -> `"Every 2 weeks on Tue, Thu"`
- Day sorting (canonical order): `buildCustomFrequency("1", "weeks", ["Fri", "Mon", "Wed"])` -> `"Weekly on Mon, Wed, Fri"` (sorted by DAYS_LIST order, not input order)
- Invalid interval defaults to 1: `buildCustomFrequency("abc", "days", [])` -> `"Daily"`
- Empty interval defaults to 1: `buildCustomFrequency("", "weeks", [])` -> `"Weekly"`

**parseCustomFrequency tests:**
- Parse "Daily" -> NOT handled by parser (returns default `{ interval: "1", period: "weeks", days: [] }`) — this is the current inline behavior, preserve it exactly
- Parse "Weekly on Mon, Wed, Fri" -> `{ interval: "1", period: "weeks", days: ["Mon", "Wed", "Fri"] }`
- Parse "Every 2 weeks on Tue, Thu" -> `{ interval: "2", period: "weeks", days: ["Tue", "Thu"] }`
- Parse "Every 3 days" -> `{ interval: "3", period: "days", days: [] }`
- Parse "Every 1 weeks" -> `{ interval: "1", period: "weeks", days: [] }`
- Parse empty string -> `{ interval: "1", period: "weeks", days: [] }` (default)

**Round-trip tests:**
- `parseCustomFrequency(buildCustomFrequency("1", "weeks", ["Mon", "Wed"]))` returns `{ interval: "1", period: "weeks", days: ["Mon", "Wed"] }`
- `parseCustomFrequency(buildCustomFrequency("2", "weeks", ["Tue", "Thu"]))` returns `{ interval: "2", period: "weeks", days: ["Tue", "Thu"] }`
- `parseCustomFrequency(buildCustomFrequency("3", "days", []))` returns `{ interval: "3", period: "days", days: [] }`

**DAYS_LIST tests:**
- `DAYS_LIST` has length 7
- `DAYS_LIST[0]` is `"Mon"` and `DAYS_LIST[6]` is `"Sun"`

3. Run tests: `npx jest lib/utils/frequency.test.ts` — must pass.

4. Add per-path 70% coverage threshold for `lib/utils/frequency.ts` in `jest.config.js`.

5. Run `npx jest --coverage` to verify threshold met.

6. Commit: `feat(02-02): extract frequency utilities to lib/utils/frequency.ts with tests`
  </action>
  <verify>
- `npx jest lib/utils/frequency.test.ts --verbose` passes all test cases (15+ tests)
- `npx jest --coverage` passes with per-path threshold for frequency.ts
- `lib/utils/frequency.ts` exports buildCustomFrequency, parseCustomFrequency, and DAYS_LIST
- Run `npx expo start` and spot-check frequency display in guided-builder (per user decision: verify app after each extraction)
  </verify>
  <done>buildCustomFrequency and parseCustomFrequency extracted to lib/utils/frequency.ts with 15+ test cases covering all frequency patterns, edge cases, and round-trip consistency. DAYS_LIST constant exported. Per-path 70% coverage threshold active.</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline frequency code in all 3 screen files with shared imports</name>
  <files>app/guided-builder.tsx, app/edit-habit.tsx, app/add-habit.tsx</files>
  <action>
**EXTRACT phase — Replace inline code with imports in all 3 files (per user decision: one commit per utility):**

**In `app/guided-builder.tsx`:**
1. Add import: `import { buildCustomFrequency, DAYS_LIST } from "@/lib/utils/frequency";`
2. Comment out the inline `DAYS_LIST` constant (line ~88) with `// EXTRACTED to @/lib/utils/frequency.ts` prefix
3. Replace the inline `buildCustomFrequency` closure (lines 97-106) with a call to the imported pure function. The closure currently reads `customInterval`, `customPeriod`, `customDays` from component scope. Replace:
   - The closure definition with: `// EXTRACTED to @/lib/utils/frequency.ts`
   - Usage at line 108 (`const resolvedFrequency = frequency === "Custom" ? buildCustomFrequency() : frequency;`) with: `const resolvedFrequency = frequency === "Custom" ? buildCustomFrequency(customInterval, customPeriod, customDays) : frequency;`
   - Usage at line ~471 (`{buildCustomFrequency()}`) with: `{buildCustomFrequency(customInterval, customPeriod, customDays)}`
4. Ensure `DAYS_LIST` references still work (used in day toggle UI at line ~450)

**In `app/edit-habit.tsx`:**
1. Add import: `import { buildCustomFrequency, parseCustomFrequency, DAYS_LIST } from "@/lib/utils/frequency";`
2. Comment out the inline `DAYS` constant (line ~78) with `// EXTRACTED to @/lib/utils/frequency.ts`
3. Replace all references to `DAYS` with `DAYS_LIST` in this file (the constant was named `DAYS` locally but is `DAYS_LIST` in the shared module)
4. Comment out the inline `parseCustomFrequency` closure (lines 80-97) with `// EXTRACTED to @/lib/utils/frequency.ts`
5. Comment out the inline `buildCustomFrequency` closure (lines 115-124) with `// EXTRACTED to @/lib/utils/frequency.ts`
6. Update `buildCustomFrequency()` calls to pass parameters: `buildCustomFrequency(customInterval, customPeriod, customDays)` at lines ~126 and ~502

**In `app/add-habit.tsx`:**
1. Add import: `import { buildCustomFrequency, DAYS_LIST } from "@/lib/utils/frequency";`
2. Comment out the inline `DAYS` constant (line ~68) with `// EXTRACTED to @/lib/utils/frequency.ts`
3. Replace all references to `DAYS` with `DAYS_LIST` in this file
4. Comment out the inline `buildCustomFrequency` closure (lines 77-86) with `// EXTRACTED to @/lib/utils/frequency.ts`
5. Update `buildCustomFrequency()` calls to pass parameters: `buildCustomFrequency(customInterval, customPeriod, customDays)` at lines ~88 and ~377

**Verify:**
6. Run full test suite: `npx jest` — all tests must pass (existing smoke test + all new utility tests)
7. Commit: `refactor(02-02): replace inline frequency code with shared imports in 3 screen files`
  </action>
  <verify>
- `npx jest` passes all tests
- `grep -rn "import.*from.*@/lib/utils/frequency" app/guided-builder.tsx app/edit-habit.tsx app/add-habit.tsx` shows imports in all 3 files
- `grep -c "EXTRACTED" app/guided-builder.tsx app/edit-habit.tsx app/add-habit.tsx` shows commented-out code in all 3 files
- No uncommented `buildCustomFrequency` closure definition remains in any screen file
- No uncommented `parseCustomFrequency` closure definition remains in edit-habit.tsx
- Run `npx expo start` and spot-check custom frequency selection in guided-builder, edit-habit, and add-habit screens (per user decision: verify app after each extraction)
  </verify>
  <done>All 3 screen files (guided-builder, edit-habit, add-habit) import from shared lib/utils/frequency.ts. Inline buildCustomFrequency closures replaced in all 3 files. Inline parseCustomFrequency replaced in edit-habit. DAYS_LIST/DAYS constant deduplicated. Old inline code commented out for safety.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx jest` — all tests pass
2. `npx jest --coverage` — per-path 70% threshold met for frequency.ts
3. `grep -rn "buildCustomFrequency\|parseCustomFrequency" app/guided-builder.tsx app/edit-habit.tsx app/add-habit.tsx` — only import statements and call sites remain (no function definitions)
4. Verify app runs: `npx expo start` and test custom frequency selection in guided-builder, edit-habit, and add-habit screens (per user decision: verify app after each extraction)
</verification>

<success_criteria>
- buildCustomFrequency and parseCustomFrequency live in lib/utils/frequency.ts with comprehensive tests
- Deduplication eliminates 3 copies of buildCustomFrequency and 1 copy of parseCustomFrequency
- DAYS_LIST constant shared across all 3 screen files
- All existing tests continue to pass
- Per-path 70% coverage threshold enforced on frequency.ts
- 2 atomic commits: one for utility creation + tests, one for import rewiring across all 3 screens
</success_criteria>

<output>
After completion, create `.planning/phases/02-utility-hook-extraction/02-02-SUMMARY.md`
</output>
