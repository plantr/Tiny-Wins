---
phase: 03-component-extraction-testing
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/habits/builder/IdentityStep.test.tsx
  - components/habits/builder/HabitStep.test.tsx
  - components/habits/builder/SummaryStep.test.tsx
  - app/guided-builder.test.tsx
autonomous: true

must_haves:
  truths:
    - "Guided builder step components render correct content for each step"
    - "Guided builder orchestrator navigates between steps correctly"
    - "Identity step renders identity area chips and custom input"
    - "Habit step renders icon grid, color options, and frequency pills"
    - "Summary step renders habit preview with all configured values"
  artifacts:
    - path: "components/habits/builder/IdentityStep.test.tsx"
      provides: "Tests for identity step rendering and interaction"
    - path: "components/habits/builder/HabitStep.test.tsx"
      provides: "Tests for habit configuration step rendering"
    - path: "components/habits/builder/SummaryStep.test.tsx"
      provides: "Tests for summary step rendering"
    - path: "app/guided-builder.test.tsx"
      provides: "Integration test for guided builder navigation"
  key_links:
    - from: "app/guided-builder.test.tsx"
      to: "app/guided-builder.tsx"
      via: "import and render GuidedBuilderScreen"
      pattern: "import.*GuidedBuilderScreen"
---

<objective>
Write tests for the extracted guided-builder step components and an integration test for the guided-builder orchestrator.

Purpose: Establish test coverage for the first extracted screen. Tests validate that components render correctly in isolation and that the orchestrator navigates between steps. This builds the testing pattern for subsequent screens.

Output: 3 step component test files + 1 orchestrator integration test.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-component-extraction-testing/03-01-SUMMARY.md
@lib/test-utils.tsx
@lib/habits-context.tsx
@lib/identity-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for IdentityStep, HabitStep, and SummaryStep components</name>
  <files>
    components/habits/builder/IdentityStep.test.tsx
    components/habits/builder/HabitStep.test.tsx
    components/habits/builder/SummaryStep.test.tsx
  </files>
  <action>
    **General test pattern for step components:**
    - Import `render`, `screen`, `waitFor`, `fireEvent` from `@/lib/test-utils`
    - Import the step component from its file
    - Create mock props that match the component's interface (jest.fn() for setters, string values for state)
    - Wrap assertions in `waitFor` (providers hydrate asynchronously)
    - Pass `colors` from a known mock or render within the test wrapper and pass real theme colors

    **For step component colors:** Since step components receive `colors` as a prop (not calling useTheme directly), create a test helper:
    ```typescript
    const mockColors = {
      text: '#FFFFFF', textSecondary: '#999', textMuted: '#666',
      accent: '#FF3B7F', accentOrange: '#FF8C42', accentPurple: '#7B61FF',
      accentCyan: '#00E5C3', accentYellow: '#FFD600',
      background: '#0A0A0A', surface: '#1A1A1A', surfaceLight: '#2A2A2A',
      cardBorder: '#333',
    };
    ```
    Or better: render the step component inside the test-utils wrapper which provides ThemeProvider, and extract colors from useTheme in a test-helper component. But since these step components take colors as props, just pass mock colors directly -- the component renders without needing the provider for colors.

    NOTE: Step components may still need the test wrapper if they call context hooks internally (e.g., IdentityStep doesn't, it gets everything via props). Check each component's imports to determine if provider wrapping is needed.

    **IdentityStep.test.tsx:**
    - Test 1: "renders identity area chips" -- render with default props, verify at least 3 identity area labels appear (e.g., "An athlete", "A reader")
    - Test 2: "shows custom identity input when custom selected" -- render with `identityAreaId="custom"`, verify TextInput with placeholder "e.g. a disciplined person" appears
    - Test 3: "calls setIdentityAreaId when chip pressed" -- render, press an identity chip, verify setIdentityAreaId called with correct id

    **HabitStep.test.tsx:**
    - Test 1: "renders habit name input" -- render with default props, verify TextInput with placeholder containing "Read, Meditate" appears
    - Test 2: "renders icon grid with all options" -- render, verify at least 12 icon buttons render
    - Test 3: "renders frequency options" -- render, verify "Daily", "Weekdays", "Custom" text appears

    **SummaryStep.test.tsx:**
    - Test 1: "renders habit title in summary card" -- render with `title="Morning Run"`, verify "Morning Run" text appears
    - Test 2: "renders target info" -- render with `goal="3"`, `unit="times"`, `resolvedFrequency="Daily"`, verify "3 times / Daily" text appears
    - Test 3: "renders identity row when identityAreaId set" -- render with `identityAreaId="athlete"`, verify "identity:" label appears
  </action>
  <verify>
    - `npx jest components/habits/builder/IdentityStep.test.tsx --no-coverage` passes
    - `npx jest components/habits/builder/HabitStep.test.tsx --no-coverage` passes
    - `npx jest components/habits/builder/SummaryStep.test.tsx --no-coverage` passes
  </verify>
  <done>
    3 step component test files exist and pass. Tests verify rendering of key UI elements and basic interactions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write integration test for guided-builder orchestrator</name>
  <files>
    app/guided-builder.test.tsx
  </files>
  <action>
    **Guided builder integration test (app/guided-builder.test.tsx):**

    This tests the full guided builder screen -- the orchestrator plus all step components together. It validates navigation between steps and the overall flow.

    - Import `render`, `screen`, `waitFor`, `fireEvent` from `@/lib/test-utils`
    - Import `GuidedBuilderScreen` as default export from `@/app/guided-builder`

    **Mock expo-router:** Since guided-builder calls `router.back()` and tests don't have router context:
    ```typescript
    jest.mock('expo-router', () => ({
      router: { back: jest.fn(), push: jest.fn() },
    }));
    ```

    **Mock expo-haptics:** Already mocked in jest.setup.js, but verify. If not:
    ```typescript
    jest.mock('expo-haptics', () => ({
      impactAsync: jest.fn(),
      notificationAsync: jest.fn(),
      ImpactFeedbackStyle: { Light: 'light', Medium: 'medium' },
      NotificationFeedbackType: { Success: 'success', Warning: 'warning' },
    }));
    ```

    **Tests:**
    - Test 1: "renders first step (identity) on mount" -- render GuidedBuilderScreen, verify "identity link" title and "who do you want to become?" subtitle appear. Verify step counter shows "1/6".
    - Test 2: "navigates to next step when Next pressed" -- render, select an identity area (press a chip), press the Next button, verify step 2 content appears ("your habit" title, "what will you do?" subtitle, step counter "2/6").
    - Test 3: "navigates back when back button pressed" -- render, navigate to step 2 (select identity + press Next), press back button (arrow-left icon), verify step 1 content reappears.
    - Test 4: "disables Next button when required field empty" -- render step 1 with no identity selected, verify Next button has opacity 0.4 (disabled state).

    **Notes:**
    - The guided builder screen is complex. Focus on navigation flow, not exhaustive form testing (step tests cover individual rendering).
    - Use `fireEvent.press` for button interactions.
    - Some step transitions involve Haptics calls -- these are mocked and won't affect test behavior.
    - The "Next" button text content varies: "Next" for most steps, "Next (or skip)" for steps 3-4, "create habit" for step 5. Test can identify the button by looking for the button pressable within the footer area.
  </action>
  <verify>
    - `npx jest app/guided-builder.test.tsx --no-coverage` passes
    - `npx jest --no-coverage` -- full suite passes (no regressions)
  </verify>
  <done>
    Guided builder integration test exists and passes with at least 4 test cases covering navigation flow, step rendering, and disabled state.
  </done>
</task>

</tasks>

<verification>
1. `ls components/habits/builder/*.test.tsx app/guided-builder.test.tsx` shows 4 test files
2. `npx jest components/habits/builder/ app/guided-builder.test.tsx --no-coverage` -- all tests pass
3. `npx jest --no-coverage` -- full suite passes
4. Each test file has at least 2 test cases
</verification>

<success_criteria>
- 3 step component test files pass with meaningful assertions
- 1 guided-builder integration test passes with navigation flow coverage
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-component-extraction-testing/03-03-SUMMARY.md`
</output>
