---
phase: 03-component-extraction-testing
plan: 06
type: execute
wave: 4
depends_on: ["03-03", "03-04", "03-05"]
files_modified:
  - lib/hooks/useFormFocus.ts
  - lib/hooks/useFormFocus.test.ts
  - jest.config.js
autonomous: true

must_haves:
  truths:
    - "Reusable hooks extracted for patterns shared across screens"
    - "Coverage thresholds updated to reflect new component test coverage"
    - "Full test suite passes with updated thresholds"
    - "All three screen files are under 300 lines"
  artifacts:
    - path: "lib/hooks/useFormFocus.ts"
      provides: "Shared hook for input focus state management (inputBorder + focusProps pattern)"
    - path: "lib/hooks/useFormFocus.test.ts"
      provides: "Tests for useFormFocus hook"
    - path: "jest.config.js"
      provides: "Updated coverage thresholds with per-path enforcement for new component files"
  key_links:
    - from: "app/guided-builder.tsx"
      to: "lib/hooks/useFormFocus.ts"
      via: "import useFormFocus for input focus management"
      pattern: "import.*useFormFocus.*from.*lib/hooks"
    - from: "app/edit-habit.tsx"
      to: "lib/hooks/useFormFocus.ts"
      via: "import useFormFocus for input focus management"
      pattern: "import.*useFormFocus.*from.*lib/hooks"
---

<objective>
Extract reusable hooks identified during component extraction, update coverage thresholds, and perform final verification that all three screens are under 300 lines.

Purpose: Complete UTIL-05 (custom hooks extraction). During Phase 3 extraction, the `inputBorder` + `focusProps` pattern was duplicated across guided-builder and edit-habit. This hook consolidates the pattern. Coverage thresholds are raised to reflect the new component test coverage from the entire phase.

Output: 1 shared hook with test + updated jest.config.js coverage thresholds.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-component-extraction-testing/03-03-SUMMARY.md
@.planning/phases/03-component-extraction-testing/03-04-SUMMARY.md
@.planning/phases/03-component-extraction-testing/03-05-SUMMARY.md
@jest.config.js
@app/guided-builder.tsx
@app/edit-habit.tsx
@app/(tabs)/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract useFormFocus hook and update screens to use it</name>
  <files>
    lib/hooks/useFormFocus.ts
    lib/hooks/useFormFocus.test.ts
    app/guided-builder.tsx
    app/edit-habit.tsx
  </files>
  <action>
    **Pattern identified during extraction:**
    Both guided-builder.tsx and edit-habit.tsx contain identical focus management code:
    ```typescript
    const [focusedField, setFocusedField] = useState<string | null>(null);
    const inputBorder = (field: string) =>
      focusedField === field ? { borderColor: colors.accent } : {};
    const focusProps = (field: string) => ({
      onFocus: () => setFocusedField(field),
      onBlur: () => setFocusedField(null),
    });
    ```

    **useFormFocus hook (lib/hooks/useFormFocus.ts):**
    ```typescript
    import { useState } from 'react';

    /**
     * Hook for managing input focus state across form fields.
     * Returns inputBorder (style object for focused field border) and
     * focusProps (onFocus/onBlur handlers for TextInputs).
     *
     * Usage:
     *   const { inputBorder, focusProps } = useFormFocus(colors.accent);
     *   <TextInput style={[styles.input, inputBorder('fieldName')]} {...focusProps('fieldName')} />
     */
    export function useFormFocus(accentColor: string) {
      const [focusedField, setFocusedField] = useState<string | null>(null);

      const inputBorder = (field: string) =>
        focusedField === field ? { borderColor: accentColor } : {};

      const focusProps = (field: string) => ({
        onFocus: () => setFocusedField(field),
        onBlur: () => setFocusedField(null),
      });

      return { focusedField, inputBorder, focusProps };
    }
    ```

    **useFormFocus test (lib/hooks/useFormFocus.test.ts):**
    - Import `renderHook`, `act` from `@testing-library/react-native` (no provider wrapper needed -- this hook doesn't use context)
    - Test 1: "returns empty border style for non-focused field" -- render hook, call inputBorder('email'), verify returns empty object {}
    - Test 2: "returns accent border when field is focused" -- render hook, simulate focus on 'email' via focusProps('email').onFocus(), call inputBorder('email'), verify returns { borderColor: accentColor }
    - Test 3: "clears border on blur" -- render hook, focus then blur a field, verify inputBorder returns empty object

    **Update guided-builder.tsx:**
    - Remove the `focusedField` state, `inputBorder` function, and `focusProps` function
    - Add: `import { useFormFocus } from '@/lib/hooks/useFormFocus';`
    - Add: `const { inputBorder, focusProps } = useFormFocus(colors.accent);`
    - Everything else stays the same -- inputBorder and focusProps have the same API

    **Update edit-habit.tsx:**
    - Same replacement: remove local state/functions, import and use useFormFocus
    - `const { inputBorder, focusProps } = useFormFocus(colors.accent);`

    **Other hooks considered but NOT extracted:**
    - `useHabitCompletion` (from research) -- the completion logic in index.tsx is tightly coupled to the evidence modal state. Extracting it would require passing modal state management, which doesn't simplify the screen. Defer to Phase 4 when integration tests clarify the pattern.
    - `toggleDay` -- appears in both screens but is trivial (3 lines). Not worth a hook.

    This is a conservative approach per the research note: "Extract hooks during component extraction as they're encountered, not as a separate pass." Only the clearly duplicated, non-trivial pattern (useFormFocus) is extracted.
  </action>
  <verify>
    - `ls lib/hooks/useFormFocus.ts lib/hooks/useFormFocus.test.ts` -- both exist
    - `npx jest lib/hooks/useFormFocus.test.ts --no-coverage` passes
    - `grep "useFormFocus" app/guided-builder.tsx app/edit-habit.tsx` shows both files import the hook
    - `grep "focusedField.*useState" app/guided-builder.tsx app/edit-habit.tsx` returns nothing (local state removed)
    - `npx jest --no-coverage` -- full suite passes
  </verify>
  <done>
    useFormFocus hook extracted to lib/hooks/ with tests. Both guided-builder and edit-habit import from shared hook. No behavior changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update coverage thresholds and perform final verification</name>
  <files>
    jest.config.js
  </files>
  <action>
    **Update jest.config.js coverage thresholds:**

    1. **Raise global floor** to reflect increased test coverage from component extraction:
       - Run `npx jest --coverage` first to see actual coverage numbers
       - Set global floor to ~2-3% below actual to avoid blocking but catch regressions
       - Expected: global floor should increase from current 2-6% to approximately 8-15% given ~20 new test files

    2. **Add per-path 70% thresholds** for new component files that have tests:
       ```javascript
       // New component files with co-located tests
       './components/shared/TodayWidget.tsx': { branches: 70, functions: 70, lines: 70, statements: 70 },
       './components/shared/IdentityBadge.tsx': { branches: 70, functions: 70, lines: 70, statements: 70 },
       './components/habits/DaySelector.tsx': { branches: 70, functions: 70, lines: 70, statements: 70 },
       './components/habits/HabitGridCard.tsx': { branches: 70, functions: 70, lines: 70, statements: 70 },
       './components/habits/HabitStackView.tsx': { branches: 70, functions: 70, lines: 70, statements: 70 },
       './lib/hooks/useFormFocus.ts': { branches: 70, functions: 70, lines: 70, statements: 70 },
       ```

       **Note:** Only add per-path thresholds for files that actually have test files passing. If some component tests were skipped or have lower coverage, set their threshold accordingly or omit.

    3. **Add components/ to collectCoverageFrom** if not already there:
       Verify `'components/**/*.{ts,tsx}'` is in the collectCoverageFrom array (it already is in current config).

    **Final verification checklist (run these commands):**
    ```bash
    # All three screens under 300 lines
    wc -l app/guided-builder.tsx app/edit-habit.tsx "app/(tabs)/index.tsx"

    # Full test suite passes with coverage
    npx jest --coverage

    # Count new component files
    find components -name "*.tsx" -not -name "*.test.tsx" | wc -l

    # Count new test files
    find components -name "*.test.tsx" | wc -l
    find lib/hooks -name "*.test.ts" | wc -l
    ```

    If any coverage threshold fails, adjust the global floor or per-path thresholds to be achievable. The goal is to enforce coverage on tested files without blocking on untested ones.
  </action>
  <verify>
    - `npx jest --coverage` passes with no threshold violations
    - `wc -l app/guided-builder.tsx` under 300
    - `wc -l app/edit-habit.tsx` under 300
    - `wc -l "app/(tabs)/index.tsx"` under 300
    - jest.config.js has per-path thresholds for new component files with tests
    - Global floor is raised above Phase 2 levels
  </verify>
  <done>
    Coverage thresholds updated. Global floor raised. Per-path 70% enforcement on tested component files. All three screens under 300 lines. Full test suite passes with coverage.
  </done>
</task>

</tasks>

<verification>
1. `npx jest --coverage` passes with all thresholds met
2. All three screen files under 300 lines: guided-builder.tsx, edit-habit.tsx, index.tsx
3. lib/hooks/useFormFocus.ts exists with passing tests
4. jest.config.js has updated global floor and per-path thresholds
5. No behavior changes from Phase 2 baseline (app works identically)
</verification>

<success_criteria>
- useFormFocus hook extracted with 100% test coverage
- Both screens updated to use shared hook
- Coverage thresholds raised appropriately
- All three screen files confirmed under 300 lines
- Full test suite passes with coverage enforcement
- Phase 3 success criteria all met: COMP-01 through COMP-13 + UTIL-05
</success_criteria>

<output>
After completion, create `.planning/phases/03-component-extraction-testing/03-06-SUMMARY.md`
</output>
