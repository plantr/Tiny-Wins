---
phase: 03-component-extraction-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/shared/constants.ts
  - components/shared/constants.test.ts
  - components/habits/builder/IdentityStep.tsx
  - components/habits/builder/HabitStep.tsx
  - components/habits/builder/IntentionStep.tsx
  - components/habits/builder/StackingStep.tsx
  - components/habits/builder/VersionsStep.tsx
  - components/habits/builder/SummaryStep.tsx
  - app/guided-builder.tsx
autonomous: true

must_haves:
  truths:
    - "Guided builder steps render identically after extraction (same UI, same interactions)"
    - "guided-builder.tsx is under 300 lines and imports all step components"
    - "Shared constants (ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS) are imported from one location"
  artifacts:
    - path: "components/shared/constants.ts"
      provides: "ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS shared between guided-builder and edit-habit"
    - path: "components/habits/builder/IdentityStep.tsx"
      provides: "Identity selection step component for guided builder"
    - path: "components/habits/builder/HabitStep.tsx"
      provides: "Habit name/icon/color/frequency/target step component"
    - path: "components/habits/builder/IntentionStep.tsx"
      provides: "Implementation intention step component"
    - path: "components/habits/builder/StackingStep.tsx"
      provides: "Habit stacking step component"
    - path: "components/habits/builder/VersionsStep.tsx"
      provides: "Two-minute rule versions step component"
    - path: "components/habits/builder/SummaryStep.tsx"
      provides: "Summary/review step component"
    - path: "app/guided-builder.tsx"
      provides: "Orchestrator under 300 lines importing all step components"
  key_links:
    - from: "app/guided-builder.tsx"
      to: "components/habits/builder/*.tsx"
      via: "import and render in renderStepContent switch"
      pattern: "import.*from.*components/habits/builder"
    - from: "components/habits/builder/HabitStep.tsx"
      to: "components/shared/constants.ts"
      via: "import ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS"
      pattern: "import.*from.*components/shared/constants"
---

<objective>
Extract guided-builder.tsx (1096 lines) into focused step components and a thin orchestrator, plus shared constants module.

Purpose: Decompose the largest-complexity screen first (per locked extraction order) to establish component extraction patterns. Shared constants module eliminates duplication between guided-builder and edit-habit.

Output: 6 step component files in components/habits/builder/, 1 shared constants file, guided-builder.tsx reduced to <300 line orchestrator.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/guided-builder.tsx
@lib/habits-context.tsx
@lib/identity-context.tsx
@lib/utils/frequency.ts
@lib/test-utils.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared constants and guided-builder step components</name>
  <files>
    components/shared/constants.ts
    components/habits/builder/IdentityStep.tsx
    components/habits/builder/HabitStep.tsx
    components/habits/builder/IntentionStep.tsx
    components/habits/builder/StackingStep.tsx
    components/habits/builder/VersionsStep.tsx
    components/habits/builder/SummaryStep.tsx
  </files>
  <action>
    **Shared constants (components/shared/constants.ts):**
    Extract from guided-builder.tsx:
    - `ICON_OPTIONS` array (lines 42-54) -- exact same data, exported as const
    - `COLOR_OPTIONS` array (lines 56-65) -- exact same data, typed with `as const` for gradient tuples
    - `UNIT_OPTIONS` array (line 67) -- exact same data
    - Type: `ColorOption` interface with `{ color: string; gradient: readonly [string, string, ...string[]] }`
    - Type: `IconOption` interface with `{ name: string; label: string }`
    These are duplicated identically in edit-habit.tsx -- this module becomes the single source.

    **Step component props pattern:**
    Each step component receives form state and setters as props from the parent orchestrator. This keeps the orchestrator as the single owner of all form state (parent-controlled pattern per Claude's discretion).

    Define a shared `BuilderFormState` interface in a types file or at the top of each step:
    ```typescript
    // Props each step needs from parent
    interface StepProps {
      colors: ReturnType<typeof useTheme>['colors'];
      selectedColor: ColorOption;
      // ... step-specific props passed from parent state
    }
    ```

    **IdentityStep.tsx (case 0, ~75 lines of JSX):**
    - Props: `identityAreaId`, `setIdentityAreaId`, `customIdentity`, `setCustomIdentity`, `inputBorder`, `focusProps`, `colors`
    - Move the entire case 0 return JSX from renderStepContent
    - Import IDENTITY_AREAS from @/lib/identity-context
    - Include the concept box, chip grid, and custom identity input

    **HabitStep.tsx (case 1, ~200 lines of JSX -- largest step):**
    - Props: `title`, `setTitle`, `icon`, `setIcon`, `colorIdx`, `setColorIdx`, `goal`, `setGoal`, `unit`, `setUnit`, `frequency`, `setFrequency`, `customInterval`, `setCustomInterval`, `customPeriod`, `setCustomPeriod`, `customDays`, `toggleDay`, `selectedColor`, `inputBorder`, `focusProps`, `colors`
    - Move the entire case 1 return JSX including icon grid, color row, frequency pills, target row, unit pills, and custom frequency panel
    - Import ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS from @/components/shared/constants
    - Import DAYS_LIST, buildCustomFrequency from @/lib/utils/frequency

    **IntentionStep.tsx (case 2, ~150 lines of JSX):**
    - Props: `title`, `intentionBehaviour`, `setIntentionBehaviour`, `intentionTime`, `setIntentionTime`, `intentionLocation`, `setIntentionLocation`, `timeMode`, `setTimeMode`, `reminderHour`, `setReminderHour`, `reminderMinute`, `setReminderMinute`, `reminderPeriod`, `setReminderPeriod`, `selectedColor`, `inputBorder`, `focusProps`, `colors`
    - Move the entire case 2 return JSX including time mode toggle, time picker, location input, and preview box

    **StackingStep.tsx (case 3, ~65 lines of JSX):**
    - Props: `habits`, `stackAnchor`, `setStackAnchor`, `intentionBehaviour`, `title`, `inputBorder`, `focusProps`, `colors`
    - Move the entire case 3 return JSX including existing habit chips, custom anchor input, and preview

    **VersionsStep.tsx (case 4, ~80 lines of JSX):**
    - Props: `title`, `twoMinVersion`, `setTwoMinVersion`, `standardVersion`, `setStandardVersion`, `stretchVersion`, `setStretchVersion`, `selectedColor`, `inputBorder`, `focusProps`, `colors`
    - Move the entire case 4 return JSX including 2-min, standard, stretch inputs and scaling preview

    **SummaryStep.tsx (case 5, ~60 lines of JSX):**
    - Props: `title`, `icon`, `selectedColor`, `identityAreaId`, `customIdentity`, `intentionBehaviour`, `intentionTime`, `intentionLocation`, `stackAnchor`, `twoMinVersion`, `goal`, `unit`, `resolvedFrequency`, `colors`
    - Move the entire case 5 return JSX including summary card with gradient and summary rows

    **Styling:** Each step component should include only the styles it uses from the original `stepStyles` and `summaryStyles` StyleSheet objects. Copy relevant style definitions into each component's local StyleSheet. Do NOT create a shared styles file -- keep styles co-located per component.

    **Important:** All step components use `useTheme()` directly for colors (per locked decision: components access context providers directly). However, since `colors` is already being passed as a prop in the current pattern for styling consistency within the builder, continue passing `colors` as a prop to step components rather than having each step call `useTheme()` independently. This keeps the builder's theme consistent across steps.
  </action>
  <verify>
    - All 7 files exist: `ls components/shared/constants.ts components/habits/builder/*.tsx`
    - TypeScript compiles: `npx tsc --noEmit` (or check for errors in the files)
    - Each step component exports a named function component
    - constants.ts exports ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS
  </verify>
  <done>
    6 step component files exist in components/habits/builder/ with proper TypeScript interfaces.
    Shared constants file exists at components/shared/constants.ts with ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reduce guided-builder.tsx to orchestrator</name>
  <files>
    app/guided-builder.tsx
  </files>
  <action>
    Rewrite guided-builder.tsx as a thin orchestrator that:

    1. **Keeps in guided-builder.tsx:**
       - All `useState` declarations (form state is owned by the orchestrator)
       - `STEPS` array (navigation metadata)
       - `canProceed()`, `handleNext()`, `handleBack()`, `handleCreate()` functions
       - `inputBorder()` and `focusProps()` helper functions
       - The main return JSX (header with progress bar, ScrollView with step title/subtitle, footer with next/create buttons)
       - The `styles` StyleSheet (header, footer, container styles)

    2. **Removes from guided-builder.tsx:**
       - All case 0-5 JSX from `renderStepContent` -- replaced with component imports
       - `ICON_OPTIONS`, `COLOR_OPTIONS`, `UNIT_OPTIONS` constants -- import from @/components/shared/constants
       - `stepStyles` and `summaryStyles` StyleSheets -- moved to individual step components
       - Any style definitions only used by step content

    3. **New `renderStepContent` implementation:**
       ```typescript
       const renderStepContent = () => {
         const commonProps = { colors, selectedColor, inputBorder, focusProps };
         switch (step) {
           case 0: return <IdentityStep {...commonProps} identityAreaId={identityAreaId} setIdentityAreaId={setIdentityAreaId} customIdentity={customIdentity} setCustomIdentity={setCustomIdentity} />;
           case 1: return <HabitStep {...commonProps} title={title} setTitle={setTitle} icon={icon} setIcon={setIcon} /* ... all habit step props */ />;
           // ... cases 2-5
           default: return null;
         }
       };
       ```

    4. **Import statements:**
       ```typescript
       import { IdentityStep } from '@/components/habits/builder/IdentityStep';
       import { HabitStep } from '@/components/habits/builder/HabitStep';
       import { IntentionStep } from '@/components/habits/builder/IntentionStep';
       import { StackingStep } from '@/components/habits/builder/StackingStep';
       import { VersionsStep } from '@/components/habits/builder/VersionsStep';
       import { SummaryStep } from '@/components/habits/builder/SummaryStep';
       ```

    5. **Target: under 300 lines.** The orchestrator should contain only: imports (~20), STEPS constant (~10), state declarations (~35), helper functions (~30), renderStepContent switch (~20), main return JSX (~50), styles (~30) = ~195 lines. Well under 300.

    **Do NOT change any behavior.** The app must work identically. Same form state management, same navigation, same habit creation. The refactoring is purely structural.
  </action>
  <verify>
    - `wc -l app/guided-builder.tsx` shows under 300 lines
    - `npx jest --passWithNoTests` passes (no test regressions)
    - File has imports from all 6 step components and from shared constants
    - No `stepStyles` or `summaryStyles` in guided-builder.tsx
  </verify>
  <done>
    guided-builder.tsx is under 300 lines, imports all 6 step components, and the app behavior is preserved (tests pass).
  </done>
</task>

</tasks>

<verification>
1. `ls components/shared/constants.ts components/habits/builder/*.tsx` shows all 7 new files
2. `wc -l app/guided-builder.tsx` shows under 300 lines
3. `npx jest --passWithNoTests` passes without errors
4. `grep -c "import.*from.*@/components" app/guided-builder.tsx` shows 6+ imports
5. `grep -c "ICON_OPTIONS\|COLOR_OPTIONS\|UNIT_OPTIONS" components/shared/constants.ts` shows all 3 constants
</verification>

<success_criteria>
- guided-builder.tsx is under 300 lines (orchestrator only)
- 6 step component files exist with proper TypeScript props interfaces
- Shared constants module exports ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS
- No behavior changes (test suite passes)
</success_criteria>

<output>
After completion, create `.planning/phases/03-component-extraction-testing/03-01-SUMMARY.md`
</output>
