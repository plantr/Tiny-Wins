---
phase: 03-component-extraction-testing
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/hooks/useBuilderFormState.ts
  - lib/hooks/useBuilderFormState.test.ts
  - app/guided-builder.tsx
  - jest.config.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "guided-builder.tsx is under 300 lines"
    - "All 103+ existing tests still pass with no regressions"
    - "Builder form state logic lives in a dedicated custom hook with tests"
  artifacts:
    - path: "lib/hooks/useBuilderFormState.ts"
      provides: "All builder form state management (useState, handlers, derived values)"
    - path: "lib/hooks/useBuilderFormState.test.ts"
      provides: "Tests for the extracted hook"
    - path: "app/guided-builder.tsx"
      provides: "Thin orchestrator under 300 lines"
  key_links:
    - from: "app/guided-builder.tsx"
      to: "lib/hooks/useBuilderFormState.ts"
      via: "import useBuilderFormState"
      pattern: "useBuilderFormState"
    - from: "lib/hooks/useBuilderFormState.ts"
      to: "lib/utils/frequency.ts"
      via: "import buildCustomFrequency"
      pattern: "buildCustomFrequency"
    - from: "lib/hooks/useBuilderFormState.ts"
      to: "lib/habits-context.tsx"
      via: "import useHabits, CueType"
      pattern: "useHabits|CueType"
---

<objective>
Close the one remaining Phase 3 verification gap: guided-builder.tsx is 357 lines, exceeding the 300-line target by 57 lines.

Purpose: Extract form state management into a `useBuilderFormState` custom hook, reducing the orchestrator to a pure UI shell that delegates all state and logic to the hook. This aligns with the Phase 3 decision to extract hooks during component extraction as they're encountered (UTIL-05) and follows the established useFormFocus pattern.

Output: guided-builder.tsx under 300 lines, new tested hook, all tests passing.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-component-extraction-testing/03-06-SUMMARY.md
@app/guided-builder.tsx
@lib/hooks/useFormFocus.ts
@jest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract useBuilderFormState hook and write tests</name>
  <files>
    lib/hooks/useBuilderFormState.ts
    lib/hooks/useBuilderFormState.test.ts
  </files>
  <action>
Create `lib/hooks/useBuilderFormState.ts` that extracts ALL form state and logic from guided-builder.tsx.

The hook must:

1. Accept parameters: `{ selectedAreaIds: string[], habits: Habit[], addHabit: Function, accentColor: string }`
   - selectedAreaIds comes from useIdentity() (called in orchestrator)
   - habits and addHabit come from useHabits() (called in orchestrator)
   - accentColor comes from useTheme() colors.accent (called in orchestrator)

2. Contain ALL useState declarations currently in guided-builder.tsx (lines 46-78):
   - step, identityAreaId, customIdentity, title, icon, colorIdx, goal, unit
   - frequency, customInterval, customPeriod, customDays
   - intentionBehaviour, intentionTime, intentionLocation
   - timeMode, reminderHour, reminderMinute, reminderPeriod
   - stackAnchor, twoMinVersion, standardVersion, stretchVersion, cueType

3. Contain these functions currently in guided-builder.tsx:
   - toggleDay (lines 59-64): toggle a day in customDays array with Haptics
   - canProceed (lines 86-91): returns boolean based on current step validation
   - handleNext (lines 93-104): advance step with auto-fill logic for standardVersion and intentionBehaviour
   - handleBack (lines 106-113): go back or call router.back()
   - handleCreate (lines 115-143): create habit via addHabit and router.back()

4. Contain these derived values:
   - resolvedFrequency (line 66): computed from frequency/customInterval/customPeriod/customDays
   - selectedColor: COLOR_OPTIONS[colorIdx]
   - currentStep: STEPS[step]
   - progress: (step + 1) / STEPS.length

5. Call useFormFocus internally (line 80) and include inputBorder/focusProps in return

6. Move the STEPS constant array (lines 29-36) INTO the hook file as a module-level export

7. Import dependencies: useState from react, Haptics from expo-haptics, router from expo-router, buildCustomFrequency from @/lib/utils/frequency, useFormFocus from @/lib/hooks/useFormFocus, COLOR_OPTIONS from @/components/shared/constants, CueType from @/lib/habits-context

8. Return object with shape:
```typescript
{
  // Navigation state
  step, currentStep, progress,
  // Form state (all values + setters needed by step components)
  identityAreaId, setIdentityAreaId, customIdentity, setCustomIdentity,
  title, setTitle, icon, setIcon, colorIdx, setColorIdx,
  goal, setGoal, unit, setUnit,
  frequency, setFrequency, customInterval, setCustomInterval,
  customPeriod, setCustomPeriod, customDays, toggleDay,
  intentionBehaviour, setIntentionBehaviour, intentionTime, setIntentionTime,
  intentionLocation, setIntentionLocation,
  timeMode, setTimeMode, reminderHour, setReminderHour,
  reminderMinute, setReminderMinute, reminderPeriod, setReminderPeriod,
  stackAnchor, setStackAnchor,
  twoMinVersion, setTwoMinVersion, standardVersion, setStandardVersion,
  stretchVersion, setStretchVersion, cueType, setCueType,
  // Derived
  selectedColor, resolvedFrequency, inputBorder, focusProps,
  // Actions
  canProceed, handleNext, handleBack, handleCreate,
}
```

For tests (`lib/hooks/useBuilderFormState.test.ts`):

Use `renderHook` from `@testing-library/react-native` to test the hook. Mock expo-router, expo-haptics, and the habits context addHabit function.

Write these tests:
1. **initializes with correct defaults** — step is 0, title is empty, frequency is "Daily", etc.
2. **canProceed returns false on step 0 with no identity selected** — verify the validation logic
3. **canProceed returns true on step 0 with identityAreaId set** — act to set identityAreaId, then check
4. **handleNext advances step** — set identityAreaId, call handleNext, verify step increments
5. **handleNext auto-fills standardVersion from title on step 1** — set step to 1, set title, call handleNext, verify standardVersion
6. **handleBack decrements step** — set step to 1, call handleBack, verify step is 0
7. **handleBack calls router.back() on step 0** — call handleBack on step 0, verify router.back called
8. **toggleDay adds and removes days** — call toggleDay('Mon'), verify customDays includes 'Mon', call again, verify removed
9. **STEPS constant is exported and has 6 entries** — import STEPS, verify length and ids

Note: For handleCreate, the test would need to verify addHabit is called with correct shape — include this as a test if feasible, skip if mock setup is too complex.
  </action>
  <verify>
Run: `cd "/Users/robert.plant/Development/Tiny Wins" && npx jest lib/hooks/useBuilderFormState.test.ts --verbose`
All tests pass. Hook file exists and exports useBuilderFormState and STEPS.
  </verify>
  <done>
useBuilderFormState hook exists at lib/hooks/useBuilderFormState.ts with all form state, handlers, and derived values extracted from guided-builder.tsx. Test file has 8+ passing tests covering initialization, validation, navigation, and day toggling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor guided-builder.tsx to use hook and update coverage</name>
  <files>
    app/guided-builder.tsx
    jest.config.js
  </files>
  <action>
Refactor `app/guided-builder.tsx` to use the new useBuilderFormState hook:

1. Remove ALL useState declarations (lines 46-78, ~33 lines)
2. Remove toggleDay function (lines 59-64, ~6 lines)
3. Remove resolvedFrequency computation (line 66, ~1 line)
4. Remove useFormFocus call and derived values (lines 80-84, ~5 lines)
5. Remove canProceed function (lines 86-91, ~6 lines)
6. Remove handleNext function (lines 93-104, ~12 lines)
7. Remove handleBack function (lines 106-113, ~8 lines)
8. Remove handleCreate function (lines 115-143, ~29 lines)
9. Remove the STEPS constant array (lines 29-36, ~8 lines)

Replace with a single destructured hook call:

```typescript
const {
  step, currentStep, progress,
  identityAreaId, setIdentityAreaId, customIdentity, setCustomIdentity,
  title, setTitle, icon, setIcon, colorIdx, setColorIdx,
  goal, setGoal, unit, setUnit,
  frequency, setFrequency, customInterval, setCustomInterval,
  customPeriod, setCustomPeriod, customDays, toggleDay,
  intentionBehaviour, setIntentionBehaviour, intentionTime, setIntentionTime,
  intentionLocation, setIntentionLocation,
  timeMode, setTimeMode, reminderHour, setReminderHour,
  reminderMinute, setReminderMinute, reminderPeriod, setReminderPeriod,
  stackAnchor, setStackAnchor,
  twoMinVersion, setTwoMinVersion, standardVersion, setStandardVersion,
  stretchVersion, setStretchVersion, cueType, setCueType,
  selectedColor, resolvedFrequency, inputBorder, focusProps,
  canProceed, handleNext, handleBack, handleCreate,
} = useBuilderFormState({ selectedAreaIds, habits, addHabit, accentColor: colors.accent });
```

Update imports:
- Remove: useState from react (if no longer needed), buildCustomFrequency, useFormFocus, COLOR_OPTIONS (moved to hook)
- Add: useBuilderFormState from @/lib/hooks/useBuilderFormState, STEPS from @/lib/hooks/useBuilderFormState
- Keep: useTheme, useHabits, useIdentity (still called in orchestrator to pass to hook)

The renderStepContent function and all JSX remain in the orchestrator — the hook handles state, the orchestrator handles rendering.

After refactoring, verify the file is under 300 lines with `wc -l app/guided-builder.tsx`.

Also update `jest.config.js`:
- Add per-path 70% threshold for `./lib/hooks/useBuilderFormState.ts` in the Hooks section (after useFormFocus entry)

Run the FULL test suite to verify no regressions: `npx jest --verbose`
All 103+ tests must pass including the existing guided-builder.test.tsx integration tests.
  </action>
  <verify>
Run these checks:
1. `wc -l app/guided-builder.tsx` — must be under 300
2. `cd "/Users/robert.plant/Development/Tiny Wins" && npx jest --verbose` — all tests pass
3. `cd "/Users/robert.plant/Development/Tiny Wins" && npx jest --coverage` — coverage thresholds met
  </verify>
  <done>
guided-builder.tsx is under 300 lines, uses useBuilderFormState hook for all state management, all existing tests pass with no regressions, coverage thresholds updated and met.
  </done>
</task>

</tasks>

<verification>
1. `wc -l app/guided-builder.tsx` shows under 300 lines
2. `npx jest --verbose` — all tests pass (103+ tests, 21+ suites)
3. `npx jest --coverage` — all coverage thresholds met
4. `grep -c "useBuilderFormState" app/guided-builder.tsx` — returns at least 1 (hook is imported and used)
5. `wc -l lib/hooks/useBuilderFormState.ts` — file exists with extracted logic
6. `wc -l lib/hooks/useBuilderFormState.test.ts` — test file exists with assertions
</verification>

<success_criteria>
- guided-builder.tsx is under 300 lines (closing the verification gap)
- useBuilderFormState hook exists with all form state, handlers, and derived values
- Hook has co-located test file with 8+ passing tests
- All 103+ existing tests pass with no regressions
- Coverage thresholds include new hook file at 70%
- Phase 3 verification gap is fully closed
</success_criteria>

<output>
After completion, create `.planning/phases/03-component-extraction-testing/03-07-SUMMARY.md`
</output>
