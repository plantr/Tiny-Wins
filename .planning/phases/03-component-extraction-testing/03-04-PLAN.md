---
phase: 03-component-extraction-testing
plan: 04
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - components/modals/EvidenceModal.tsx
  - components/modals/EvidenceModal.test.tsx
  - components/modals/AddHabitChoiceModal.tsx
  - components/modals/AddHabitChoiceModal.test.tsx
  - components/modals/RemindersModal.tsx
  - components/modals/RemindersModal.test.tsx
  - components/modals/ConfirmationModal.tsx
  - components/modals/ConfirmationModal.test.tsx
  - app/(tabs)/index.tsx
autonomous: true

must_haves:
  truths:
    - "Today screen index.tsx is under 300 lines and imports all components"
    - "EvidenceModal renders note input, image actions, and submit/skip buttons"
    - "AddHabitChoiceModal renders quick add and guided builder options"
    - "RemindersModal renders habits with reminder management"
    - "ConfirmationModal renders as a reusable modal with configurable title, message, and actions"
    - "App behavior is identical after extraction (habit completion, evidence logging, reminders all work)"
  artifacts:
    - path: "components/modals/EvidenceModal.tsx"
      provides: "Evidence of identity modal for habit completion"
    - path: "components/modals/AddHabitChoiceModal.tsx"
      provides: "Modal for choosing quick add vs guided builder"
    - path: "components/modals/RemindersModal.tsx"
      provides: "Reminder management modal with time picker"
    - path: "components/modals/ConfirmationModal.tsx"
      provides: "Reusable confirmation dialog (used for uncomplete, could be used for delete)"
    - path: "app/(tabs)/index.tsx"
      provides: "Thin orchestrator under 300 lines"
  key_links:
    - from: "app/(tabs)/index.tsx"
      to: "components/modals/EvidenceModal.tsx"
      via: "import and render with visibility state"
      pattern: "import.*EvidenceModal.*from.*components/modals"
    - from: "app/(tabs)/index.tsx"
      to: "components/habits/HabitGridCard.tsx"
      via: "import and render in habits grid"
      pattern: "import.*HabitGridCard.*from.*components/habits"
    - from: "app/(tabs)/index.tsx"
      to: "components/shared/TodayWidget.tsx"
      via: "import and render"
      pattern: "import.*TodayWidget.*from.*components/shared"
---

<objective>
Extract all 4 modal components from index.tsx to individual files with tests, then reduce index.tsx to a thin orchestrator under 300 lines.

Purpose: Complete the Today screen extraction (COMP-07, COMP-08, COMP-09, COMP-10, COMP-11). The inline confirmation modal is genericized into a reusable ConfirmationModal component. After all components are extracted, index.tsx becomes a pure orchestrator managing modal visibility state and composition.

Output: 4 modal component files + 4 test files + index.tsx reduced to <300 lines.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-component-extraction-testing/03-02-SUMMARY.md
@app/(tabs)/index.tsx
@lib/test-utils.tsx
@lib/habits-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract modal components from index.tsx with tests</name>
  <files>
    components/modals/EvidenceModal.tsx
    components/modals/EvidenceModal.test.tsx
    components/modals/AddHabitChoiceModal.tsx
    components/modals/AddHabitChoiceModal.test.tsx
    components/modals/RemindersModal.tsx
    components/modals/RemindersModal.test.tsx
    components/modals/ConfirmationModal.tsx
    components/modals/ConfirmationModal.test.tsx
  </files>
  <action>
    **EvidenceModal (components/modals/EvidenceModal.tsx):**
    - Copy the entire `function EvidenceModal()` (lines 660-793 of index.tsx) to its own file
    - Copy the `modalStyles` StyleSheet (lines 1424-1472)
    - Keep existing prop interface: `{ visible, habitTitle, onSubmit, onSkip, onClose }`
    - Export as named export with props interface exported separately
    - Imports: React, RN components (Modal, View, Text, Pressable, TextInput, Image), LinearGradient, Ionicons/Feather, Haptics, ImagePicker, useTheme

    **EvidenceModal test (components/modals/EvidenceModal.test.tsx):**
    - Mock expo-image-picker: `jest.mock('expo-image-picker', () => ({ launchImageLibraryAsync: jest.fn(), requestCameraPermissionsAsync: jest.fn(), launchCameraAsync: jest.fn() }))`
    - Test 1: "renders title and subtitle when visible" -- render with `visible={true}`, verify "evidence of identity" text appears
    - Test 2: "calls onSkip when skip button pressed" -- render, press "skip" button, verify onSkip called
    - Test 3: "calls onClose when close button pressed" -- render, press close (X) button, verify onClose called

    **AddHabitChoiceModal (components/modals/AddHabitChoiceModal.tsx):**
    - Copy the entire `function AddHabitChoiceModal()` (lines 796-858 of index.tsx) to its own file
    - Copy the `choiceStyles` StyleSheet (lines 1474-1493)
    - Keep existing prop interface: `{ visible, onClose }`
    - Imports: React, RN components, Ionicons/Feather, Haptics, router, useTheme

    **AddHabitChoiceModal test (components/modals/AddHabitChoiceModal.test.tsx):**
    - Mock expo-router: `jest.mock('expo-router', () => ({ router: { push: jest.fn(), back: jest.fn() } }))`
    - Test 1: "renders quick add and guided builder options when visible" -- render with `visible={true}`, verify "quick add" and "guided builder" text appears
    - Test 2: "calls onClose when overlay pressed" -- render, press overlay, verify onClose called

    **RemindersModal (components/modals/RemindersModal.tsx):**
    - Copy BOTH `function RemindersModal()` (lines 861-943) AND `function ReminderHabitRow()` (lines 946-989) to this file
    - ReminderHabitRow is a sub-component only used within RemindersModal -- keep them together
    - Copy the `reminderStyles` StyleSheet (lines 1568-1622)
    - Keep existing prop interface: `{ visible, onClose }`
    - Imports: React, useState, RN components (Modal, View, Text, Pressable, ScrollView), Ionicons, Haptics, useTheme, useHabits (Habit type), formatTime from utils/time

    **RemindersModal test (components/modals/RemindersModal.test.tsx):**
    - Test 1: "renders empty state when no habits" -- render with `visible={true}`, verify "add habits first" text appears
    - Test 2: "renders title and subtitle when visible" -- render, verify "reminders" text appears

    **ConfirmationModal (components/modals/ConfirmationModal.tsx):**
    - Create a GENERIC reusable confirmation modal based on the inline uncomplete modal in index.tsx (lines 1212-1237) and the delete modal pattern in edit-habit.tsx
    - Props interface:
      ```typescript
      export interface ConfirmationModalProps {
        visible: boolean;
        icon: string;         // Ionicons name (e.g., "arrow-undo", "trash-2")
        iconColor: string;    // e.g., "#FF3B7F"
        title: string;        // e.g., "undo completion"
        message: string;      // e.g., "are you sure you want to..."
        confirmLabel: string; // e.g., "undo", "delete"
        confirmColor: string; // e.g., "#FF3B7F"
        cancelLabel?: string; // defaults to "cancel"
        onConfirm: () => void;
        onCancel: () => void;
      }
      ```
    - Implementation: Generic modal with icon circle, title, message, and two action buttons
    - Copy styling from `confirmStyles` (lines 1495-1515) into this component
    - This replaces the inline uncomplete modal in index.tsx AND can be reused by edit-habit's delete modal later

    **ConfirmationModal test (components/modals/ConfirmationModal.test.tsx):**
    - Test 1: "renders title and message when visible" -- render with `visible={true}`, title="delete habit", message="are you sure?", verify both texts appear
    - Test 2: "calls onConfirm when confirm button pressed" -- render, press confirm button, verify onConfirm called
    - Test 3: "calls onCancel when cancel button pressed" -- render, press cancel button, verify onCancel called
  </action>
  <verify>
    - `ls components/modals/*.tsx components/modals/*.test.tsx` shows 8 files (4 components + 4 tests)
    - `npx jest components/modals/ --no-coverage` -- all modal tests pass
  </verify>
  <done>
    4 modal components extracted with co-located tests. ConfirmationModal is a reusable generic component. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reduce index.tsx to thin orchestrator importing all extracted components</name>
  <files>
    app/(tabs)/index.tsx
  </files>
  <action>
    Rewrite index.tsx as a thin orchestrator that imports all extracted components:

    1. **Remove from index.tsx:**
       - All inline component function definitions: TodayWidget, IdentityBadge, DaySelector, HabitGridCard, HabitStackView, EvidenceModal, AddHabitChoiceModal, RemindersModal, ReminderHabitRow
       - All component-specific StyleSheets: widgetStyles, badgeStyles, dayStyles, cardStyles, stackViewStyles, modalStyles, choiceStyles, reminderStyles, confirmStyles
       - Constants only used by extracted components: RING_SIZE, RING_STROKE, ALL_DAYS, MONTHS, CARD_GAP

    2. **Add imports:**
       ```typescript
       import { TodayWidget } from '@/components/shared/TodayWidget';
       import { IdentityBadge } from '@/components/shared/IdentityBadge';
       import { DaySelector } from '@/components/habits/DaySelector';
       import { HabitGridCard } from '@/components/habits/HabitGridCard';
       import { HabitStackView } from '@/components/habits/HabitStackView';
       import { EvidenceModal } from '@/components/modals/EvidenceModal';
       import { AddHabitChoiceModal } from '@/components/modals/AddHabitChoiceModal';
       import { RemindersModal } from '@/components/modals/RemindersModal';
       import { ConfirmationModal } from '@/components/modals/ConfirmationModal';
       ```

    3. **Keep in index.tsx:**
       - The `TodayScreen` default export function
       - State declarations: evidenceModal, addChoiceVisible, remindersVisible, viewMode, uncompleteModal
       - Callback functions: handleComplete, handleEvidenceSubmit, handleEvidenceSkip, handleEvidenceClose, handleUncompleteRequest, handleUncompleteConfirm, handleUncompleteCancel
       - The main JSX return (ScrollView with component composition, modals at bottom)
       - The `styles` StyleSheet (only the main screen styles)
       - MONTHS constant (used for monthYear display in header)

    4. **Update inline uncomplete modal to use ConfirmationModal:**
       Replace the inline Modal JSX (lines 1212-1237) with:
       ```tsx
       <ConfirmationModal
         visible={uncompleteModal.visible}
         icon="arrow-undo"
         iconColor="#FF3B7F"
         title="undo completion"
         message={`are you sure you want to unmark "${uncompleteModal.habitTitle}" as done?`}
         confirmLabel="undo"
         confirmColor="#FF3B7F"
         onConfirm={handleUncompleteConfirm}
         onCancel={handleUncompleteCancel}
       />
       ```

    5. **Target: under 300 lines.** Expected breakdown:
       - Imports: ~25 lines
       - MONTHS constant: ~5 lines
       - State + callbacks: ~60 lines
       - Main JSX: ~70 lines
       - styles StyleSheet: ~40 lines
       Total: ~200 lines. Well under 300.

    **Do NOT change any behavior.** The screen must work identically. Same modal visibility management, same habit completion flow, same navigation.
  </action>
  <verify>
    - `wc -l "app/(tabs)/index.tsx"` shows under 300 lines
    - `npx jest --no-coverage` -- full suite passes (no regressions)
    - `grep -c "import.*from.*@/components" "app/(tabs)/index.tsx"` shows 9 component imports
    - No inline function definitions remain (no `function TodayWidget`, `function HabitGridCard`, etc.)
    - No component-specific StyleSheet objects remain (no widgetStyles, cardStyles, etc.)
  </verify>
  <done>
    index.tsx is under 300 lines. All components imported from extracted files. ConfirmationModal used for uncomplete dialog. Test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `wc -l "app/(tabs)/index.tsx"` under 300
2. `ls components/modals/*.tsx` shows 4 modal component files
3. `npx jest --no-coverage` -- full suite passes
4. `grep "function TodayWidget\|function IdentityBadge\|function DaySelector\|function HabitGridCard\|function HabitStackView\|function EvidenceModal\|function AddHabitChoiceModal\|function RemindersModal\|function ReminderHabitRow" "app/(tabs)/index.tsx"` returns nothing (all extracted)
5. ConfirmationModal is used instead of inline Modal for uncomplete dialog
</verification>

<success_criteria>
- index.tsx is under 300 lines (pure orchestrator)
- 4 modal components extracted with tests, all passing
- ConfirmationModal is a reusable generic component
- No behavior changes visible to the user
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-component-extraction-testing/03-04-SUMMARY.md`
</output>
