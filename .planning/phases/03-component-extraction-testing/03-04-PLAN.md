---
phase: 03-component-extraction-testing
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/modals/ConfirmationModal.tsx
  - components/modals/ConfirmationModal.test.tsx
  - components/habits/EditHabitForm.tsx
  - components/habits/EditHabitForm.test.tsx
  - components/habits/HabitPreviewCard.tsx
  - app/edit-habit.tsx
  - app/edit-habit.test.tsx
autonomous: true

must_haves:
  truths:
    - "Edit habit screen works identically after extraction (save, delete, all fields)"
    - "edit-habit.tsx is under 300 lines and imports extracted components"
    - "Edit habit imports shared constants from components/shared/constants.ts (no duplicated ICON_OPTIONS, COLOR_OPTIONS)"
    - "Edit habit uses ConfirmationModal for delete dialog (replaces inline modal)"
    - "ConfirmationModal renders as a reusable modal with configurable title, message, and actions"
  artifacts:
    - path: "components/modals/ConfirmationModal.tsx"
      provides: "Reusable confirmation dialog (used for delete in edit-habit, later reused for uncomplete in index.tsx)"
    - path: "components/modals/ConfirmationModal.test.tsx"
      provides: "Tests for ConfirmationModal rendering and interactions"
    - path: "components/habits/HabitPreviewCard.tsx"
      provides: "Gradient preview card showing habit icon, title, and progress"
    - path: "components/habits/EditHabitForm.tsx"
      provides: "Complete edit form with all habit fields (icon, color, frequency, identity, intention, versions)"
    - path: "app/edit-habit.tsx"
      provides: "Thin orchestrator under 300 lines"
    - path: "app/edit-habit.test.tsx"
      provides: "Integration test for edit habit screen"
  key_links:
    - from: "app/edit-habit.tsx"
      to: "components/habits/EditHabitForm.tsx"
      via: "import and render as main form body"
      pattern: "import.*EditHabitForm.*from.*components/habits"
    - from: "components/habits/EditHabitForm.tsx"
      to: "components/shared/constants.ts"
      via: "import ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS"
      pattern: "import.*from.*components/shared/constants"
    - from: "app/edit-habit.tsx"
      to: "components/modals/ConfirmationModal.tsx"
      via: "import for delete confirmation"
      pattern: "import.*ConfirmationModal.*from.*components/modals"
---

<objective>
Create a reusable ConfirmationModal component, then extract edit-habit.tsx (937 lines) into focused components and reduce to a thin orchestrator under 300 lines.

Purpose: Complete the second screen extraction (per locked order: guided-builder -> edit-habit -> index). Edit-habit benefits from shared constants already extracted in Plan 01. The ConfirmationModal is created here as a reusable component -- edit-habit uses it for its delete dialog, and it will be reused by index.tsx in Plan 05 for the uncomplete dialog.

Output: 1 reusable modal component + 2 new edit-habit component files + edit-habit.tsx reduced to <300 lines + tests.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-component-extraction-testing/03-01-SUMMARY.md
@app/edit-habit.tsx
@components/shared/constants.ts
@lib/test-utils.tsx
@lib/habits-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable ConfirmationModal and extract edit-habit form components</name>
  <files>
    components/modals/ConfirmationModal.tsx
    components/modals/ConfirmationModal.test.tsx
    components/habits/HabitPreviewCard.tsx
    components/habits/EditHabitForm.tsx
    app/edit-habit.tsx
  </files>
  <action>
    **ConfirmationModal (components/modals/ConfirmationModal.tsx):**
    - Create a GENERIC reusable confirmation modal based on the inline delete modal in edit-habit.tsx and the uncomplete modal pattern in index.tsx
    - Props interface:
      ```typescript
      export interface ConfirmationModalProps {
        visible: boolean;
        icon: string;         // Ionicons name (e.g., "arrow-undo", "trash-outline")
        iconColor: string;    // e.g., "#FF3B7F"
        title: string;        // e.g., "delete habit", "undo completion"
        message: string;      // e.g., "are you sure you want to..."
        confirmLabel: string; // e.g., "delete", "undo"
        confirmColor: string; // e.g., "#FF3B7F"
        cancelLabel?: string; // defaults to "cancel"
        onConfirm: () => void;
        onCancel: () => void;
      }
      ```
    - Implementation: Generic modal with icon circle, title, message, and two action buttons (cancel + confirm)
    - Style the modal using the pattern from edit-habit.tsx's delete modal (dark overlay, centered card, icon circle at top, title, message, horizontal button row)
    - Use Ionicons throughout for consistency (not Feather). Use "trash-outline" instead of Feather's "trash-2" for delete scenarios.
    - This component will be reused by edit-habit for delete AND by index.tsx (Plan 05) for uncomplete

    **ConfirmationModal test (components/modals/ConfirmationModal.test.tsx):**
    - Test 1: "renders title and message when visible" -- render with `visible={true}`, title="delete habit", message="are you sure?", verify both texts appear
    - Test 2: "calls onConfirm when confirm button pressed" -- render, press confirm button, verify onConfirm called
    - Test 3: "calls onCancel when cancel button pressed" -- render, press cancel button, verify onCancel called

    **HabitPreviewCard (components/habits/HabitPreviewCard.tsx):**
    - Extract the preview card section (lines 228-247 of edit-habit.tsx)
    - Props: `{ title: string; icon: string; selectedColor: ColorOption; currentProgress: string; goal: string; unit: string }`
    - Simple presentational component: LinearGradient background, icon circle, title, progress display
    - Include the preview-related styles (previewContainer, previewCard, previewHeader, previewIconCircle, previewTitle, previewBottom, previewGoal, previewUnit)
    - This component could be reused in guided-builder's summary step if desired

    **EditHabitForm (components/habits/EditHabitForm.tsx):**
    - Extract the form body with ALL form sections: name, icon, color, target, frequency (with custom panel), identity link, implementation intention (with time picker), habit stack, versions
    - This is the bulk of the screen: ~480 lines of JSX + ~150 lines of styles
    - Props interface (all form state and setters from parent):
      ```typescript
      export interface EditHabitFormProps {
        // Name
        title: string; setTitle: (v: string) => void;
        // Icon
        selectedIcon: string; setSelectedIcon: (v: string) => void;
        // Color
        selectedColorIdx: number; setSelectedColorIdx: (v: number) => void;
        selectedColor: ColorOption;
        // Target
        goal: string; setGoal: (v: string) => void;
        selectedUnit: string; setSelectedUnit: (v: string) => void;
        // Frequency
        selectedFrequency: string; setSelectedFrequency: (v: string) => void;
        customInterval: string; setCustomInterval: (v: string) => void;
        customPeriod: 'days' | 'weeks'; setCustomPeriod: (v: 'days' | 'weeks') => void;
        customDays: string[]; toggleDay: (day: string) => void;
        // Identity
        selectedIdentityId: string; setSelectedIdentityId: (v: string) => void;
        customIdentity: string; setCustomIdentity: (v: string) => void;
        // Intention
        intentionBehaviour: string; setIntentionBehaviour: (v: string) => void;
        intentionTime: string; setIntentionTime: (v: string) => void;
        intentionLocation: string; setIntentionLocation: (v: string) => void;
        timeMode: 'any' | 'specific'; setTimeMode: (v: 'any' | 'specific') => void;
        reminderHour: string; setReminderHour: (v: string) => void;
        reminderMinute: string; setReminderMinute: (v: string) => void;
        reminderPeriod: 'AM' | 'PM'; setReminderPeriod: (v: 'AM' | 'PM') => void;
        // Stack
        stackAnchor: string; setStackAnchor: (v: string) => void;
        // Versions
        twoMinVersion: string; setTwoMinVersion: (v: string) => void;
        standardVersion: string; setStandardVersion: (v: string) => void;
        stretchVersion: string; setStretchVersion: (v: string) => void;
        // Helpers
        inputBorder: (field: string) => object;
        focusProps: (field: string) => object;
        colors: any;
      }
      ```
    - Import ICON_OPTIONS, COLOR_OPTIONS, UNIT_OPTIONS from `@/components/shared/constants`
    - Import FREQUENCY_OPTIONS as a constant within this file (or export from constants.ts -- add to constants.ts since edit-habit and guided-builder both use the same frequency options)
    - Import IDENTITY_AREAS from `@/lib/identity-context`
    - Import DAYS_LIST, buildCustomFrequency from `@/lib/utils/frequency`
    - Include all form section styles in a local StyleSheet

    **Reduce edit-habit.tsx:**
    - Remove ICON_OPTIONS, COLOR_OPTIONS, FREQUENCY_OPTIONS, UNIT_OPTIONS -- import from shared constants
    - Remove all form section JSX -- replaced by `<EditHabitForm {...formProps} />`
    - Remove the inline delete Modal -- replaced by `<ConfirmationModal ... />`
    - Keep: state initialization, habit lookup, handleSave, handleDelete, confirmDelete, header, HabitPreviewCard usage, EditHabitForm usage, bottom save bar, ConfirmationModal usage
    - Import ConfirmationModal from `@/components/modals/ConfirmationModal`

    **Update ConfirmationModal usage for delete:**
    ```tsx
    <ConfirmationModal
      visible={showDeleteModal}
      icon="trash-outline"
      iconColor="#FF3B7F"
      title="delete habit"
      message={`are you sure you want to delete "${habit?.title}"? this can't be undone.`}
      confirmLabel="delete"
      confirmColor="#FF3B7F"
      onConfirm={confirmDelete}
      onCancel={() => setShowDeleteModal(false)}
    />
    ```

    **Target: under 300 lines for edit-habit.tsx.** Expected breakdown:
    - Imports: ~20 lines
    - EditHabitScreen function: state initialization (~60), handlers (~50), JSX (~70), styles (~40) = ~240 lines total
  </action>
  <verify>
    - `wc -l app/edit-habit.tsx` shows under 300 lines
    - `ls components/modals/ConfirmationModal.tsx components/modals/ConfirmationModal.test.tsx components/habits/HabitPreviewCard.tsx components/habits/EditHabitForm.tsx` -- all 4 exist
    - `npx jest components/modals/ConfirmationModal.test.tsx --no-coverage` passes
    - `npx jest --no-coverage` -- full suite passes
    - `grep "ICON_OPTIONS\|COLOR_OPTIONS" app/edit-habit.tsx` shows NO local definitions (only imports)
    - `grep "ConfirmationModal" app/edit-habit.tsx` shows import and usage
  </verify>
  <done>
    ConfirmationModal created as reusable component with tests. edit-habit.tsx is under 300 lines. Form sections extracted to EditHabitForm component. Preview card extracted to HabitPreviewCard. Delete modal uses shared ConfirmationModal. No behavior changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for edit-habit components and screen</name>
  <files>
    components/habits/EditHabitForm.test.tsx
    app/edit-habit.test.tsx
  </files>
  <action>
    **EditHabitForm test (components/habits/EditHabitForm.test.tsx):**
    - Create mock props factory with jest.fn() for all setters and default string values
    - Use mock colors object (same pattern as guided-builder step tests)
    - Test 1: "renders name input with current title" -- render with `title="Morning Run"`, verify input has "Morning Run" value
    - Test 2: "renders icon grid with all options" -- render, verify at least 12 icon option buttons
    - Test 3: "renders frequency options" -- render, verify "Daily", "Custom" text appears
    - Test 4: "shows custom frequency panel when Custom selected" -- render with `selectedFrequency="Custom"`, verify "repeat every" text appears

    **Edit habit screen integration test (app/edit-habit.test.tsx):**
    - Mock expo-router with `useLocalSearchParams` returning `{ id: 'test-habit-1' }`:
      ```typescript
      jest.mock('expo-router', () => ({
        router: { back: jest.fn(), push: jest.fn() },
        useLocalSearchParams: () => ({ id: 'test-habit-1' }),
      }));
      ```
    - To test the screen, need a habit to exist in context. The test-utils wrapper provides HabitsProvider which starts with empty habits.
    - **Approach:** Either:
      a) Set up AsyncStorage before render with a pre-populated habit, OR
      b) Accept that the screen will show "habit not found" for the basic test, and focus on testing that state

    - Test 1: "renders habit not found when habit doesn't exist" -- render EditHabitScreen with mock params for non-existent id, verify "habit not found" text
    - Test 2: "renders edit habit header" -- Set up a habit in AsyncStorage before render (using the async storage mock), render EditHabitScreen, verify "edit habit" header text appears after waitFor
    - Test 3: "renders save button" -- render with a valid habit, verify "save changes" button text appears

    **Note:** Testing the full edit-habit screen with pre-populated habit data requires setting up AsyncStorage with habits data before rendering. Pattern:
    ```typescript
    import AsyncStorage from '@react-native-async-storage/async-storage';

    beforeEach(async () => {
      await AsyncStorage.setItem('tinywins_habits', JSON.stringify([{
        id: 'test-habit-1',
        title: 'Test Habit',
        icon: 'fitness',
        iconColor: '#FF3B7F',
        gradientColors: ['#FF3B7F', '#FF6B9D', '#FF8CB0'],
        goal: 1, unit: 'times', frequency: 'Daily',
        current: 0, streak: 0, bestStreak: 0,
        weekData: [0,0,0,0,0,0,0], createdAt: Date.now(),
      }]));
    });
    ```
    This makes the HabitsProvider load the habit from storage when it hydrates.
  </action>
  <verify>
    - `npx jest components/habits/EditHabitForm.test.tsx --no-coverage` passes
    - `npx jest app/edit-habit.test.tsx --no-coverage` passes
    - `npx jest --no-coverage` -- full suite passes
  </verify>
  <done>
    EditHabitForm component test and edit-habit screen integration test pass. Tests cover form rendering, frequency panel toggle, and screen-level behavior (not-found state, header rendering).
  </done>
</task>

</tasks>

<verification>
1. `wc -l app/edit-habit.tsx` under 300 lines
2. `ls components/modals/ConfirmationModal.tsx components/habits/HabitPreviewCard.tsx components/habits/EditHabitForm.tsx` exist
3. `npx jest components/modals/ConfirmationModal.test.tsx app/edit-habit.test.tsx components/habits/EditHabitForm.test.tsx --no-coverage` passes
4. `npx jest --no-coverage` -- full suite passes
5. No duplicated constants in edit-habit.tsx (uses shared imports)
6. ConfirmationModal used for delete dialog
</verification>

<success_criteria>
- ConfirmationModal is a reusable generic component with tests
- edit-habit.tsx under 300 lines
- Form sections extracted to EditHabitForm component
- HabitPreviewCard extracted as presentational component
- Shared constants imported (no duplication)
- ConfirmationModal reused for delete dialog
- Integration and component tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-component-extraction-testing/03-04-SUMMARY.md`
</output>
