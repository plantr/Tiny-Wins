---
phase: 03-component-extraction-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/shared/TodayWidget.tsx
  - components/shared/TodayWidget.test.tsx
  - components/shared/IdentityBadge.tsx
  - components/shared/IdentityBadge.test.tsx
  - components/habits/DaySelector.tsx
  - components/habits/DaySelector.test.tsx
  - components/habits/HabitGridCard.tsx
  - components/habits/HabitGridCard.test.tsx
  - components/habits/HabitStackView.tsx
  - components/habits/HabitStackView.test.tsx
autonomous: true

must_haves:
  truths:
    - "TodayWidget renders greeting, progress ring, stats, and habit dots identically to inline version"
    - "IdentityBadge renders identity areas and custom identities from context"
    - "DaySelector renders week days respecting weekStartDay setting from theme context"
    - "HabitGridCard renders habit with gradient, icon, title, progress, and check button"
    - "HabitStackView renders habit chains and standalone habits with correct hierarchy"
  artifacts:
    - path: "components/shared/TodayWidget.tsx"
      provides: "Today progress widget with ring, stats, and habit dots"
    - path: "components/shared/IdentityBadge.tsx"
      provides: "Identity badge showing selected identity areas"
    - path: "components/habits/DaySelector.tsx"
      provides: "Week day selector with current day highlight"
    - path: "components/habits/HabitGridCard.tsx"
      provides: "Grid card view for individual habit"
    - path: "components/habits/HabitStackView.tsx"
      provides: "Stack/chain view for habits with stacking relationships"
  key_links:
    - from: "components/shared/TodayWidget.tsx"
      to: "@/lib/habits-context"
      via: "useHabits() for habits and logs"
      pattern: "useHabits"
    - from: "components/habits/DaySelector.tsx"
      to: "@/lib/theme-context"
      via: "useTheme() for weekStartDay and colors"
      pattern: "useTheme"
---

<objective>
Extract 5 inline components from index.tsx (TodayWidget, IdentityBadge, DaySelector, HabitGridCard, HabitStackView) into individual files with co-located tests.

Purpose: These components are already self-contained functions in index.tsx. Moving them to files is straightforward extraction that can run in parallel with guided-builder extraction (Plan 01). Each gets a test file validating key rendering behavior.

Output: 5 component files + 5 test files in components/shared/ and components/habits/.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/(tabs)/index.tsx
@lib/test-utils.tsx
@lib/habits-context.tsx
@lib/theme-context.tsx
@lib/identity-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract TodayWidget, IdentityBadge, and DaySelector to component files with tests</name>
  <files>
    components/shared/TodayWidget.tsx
    components/shared/TodayWidget.test.tsx
    components/shared/IdentityBadge.tsx
    components/shared/IdentityBadge.test.tsx
    components/habits/DaySelector.tsx
    components/habits/DaySelector.test.tsx
  </files>
  <action>
    **TodayWidget (components/shared/TodayWidget.tsx):**
    - Copy the entire `function TodayWidget()` (lines 54-176 of index.tsx) to its own file
    - Copy the `widgetStyles` StyleSheet (lines 1517-1565) to the bottom of the file
    - Copy the `RING_SIZE` and `RING_STROKE` constants (lines 36-37) -- these are only used by TodayWidget
    - Imports needed: React, RN components, LinearGradient, Ionicons, Animated/reanimated, useTheme, useHabits, getTodayStr
    - Export as named export: `export function TodayWidget()`
    - No props needed -- it accesses context directly (per locked decision)

    **TodayWidget test (components/shared/TodayWidget.test.tsx):**
    - Import from `@/lib/test-utils` (custom render with all providers)
    - Test 1: "returns null when no habits exist" -- render TodayWidget, verify nothing renders (habits array starts empty in test context)
    - Test 2: "renders greeting text" -- Add a habit via context setup (or mock), verify greeting text appears ("good morning" / "good afternoon" / "good evening" depending on time)
    - Use `waitFor` for all assertions (AsyncStorage hydration)
    - Use `jest.useFakeTimers()` to control time-of-day for greeting test

    **IdentityBadge (components/shared/IdentityBadge.tsx):**
    - Copy the entire `function IdentityBadge()` (lines 178-243 of index.tsx) to its own file
    - Copy the `badgeStyles` StyleSheet (lines 1394-1408)
    - Imports needed: React, RN components, LinearGradient, Ionicons, useTheme, useIdentity, IDENTITY_AREAS, useHabits
    - Export as named export: `export function IdentityBadge()`

    **IdentityBadge test (components/shared/IdentityBadge.test.tsx):**
    - Test 1: "returns null when no identity selected and no habits" -- verify empty render
    - Use `waitFor` for assertions

    **DaySelector (components/habits/DaySelector.tsx):**
    - Copy the entire `function DaySelector()` (lines 246-291 of index.tsx) to its own file
    - Copy the `dayStyles` StyleSheet (lines 1411-1421)
    - Copy the `ALL_DAYS` constant (lines 39-47) -- only used by DaySelector
    - Imports needed: React, RN components, useTheme, WEEK_START_INDEX, useHabits, getTodayStr
    - Export as named export: `export function DaySelector()`

    **DaySelector test (components/habits/DaySelector.test.tsx):**
    - Test 1: "renders 7 day labels" -- render DaySelector, verify 7 day circles appear
    - Test 2: "highlights current day" -- use fake timers to set a known day, verify the current day has accent styling
    - Use `waitFor` for assertions

    **Important:** Do NOT modify index.tsx in this task. The inline functions will be replaced in Plan 04 when the orchestrator is reduced.
  </action>
  <verify>
    - `ls components/shared/TodayWidget.tsx components/shared/TodayWidget.test.tsx components/shared/IdentityBadge.tsx components/shared/IdentityBadge.test.tsx components/habits/DaySelector.tsx components/habits/DaySelector.test.tsx` -- all 6 files exist
    - `npx jest components/shared/TodayWidget.test.tsx --no-coverage` passes
    - `npx jest components/shared/IdentityBadge.test.tsx --no-coverage` passes
    - `npx jest components/habits/DaySelector.test.tsx --no-coverage` passes
  </verify>
  <done>
    TodayWidget, IdentityBadge, and DaySelector extracted to individual files. Each has a co-located test file with passing tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract HabitGridCard and HabitStackView to component files with tests</name>
  <files>
    components/habits/HabitGridCard.tsx
    components/habits/HabitGridCard.test.tsx
    components/habits/HabitStackView.tsx
    components/habits/HabitStackView.test.tsx
  </files>
  <action>
    **HabitGridCard (components/habits/HabitGridCard.tsx):**
    - Copy the entire `function HabitGridCard()` (lines 293-417 of index.tsx) to its own file
    - Copy the `cardStyles` StyleSheet (lines 1290-1341)
    - Copy the `CARD_GAP` constant (line 35) if used in card styling
    - Keep the existing prop interface inline: `{ habit: Habit; index: number; isCompleted: boolean; onComplete: (id: string) => void; onUncomplete: (id: string) => void; }`
    - Export the interface as well: `export interface HabitGridCardProps { ... }`
    - Imports needed: React, RN components, LinearGradient, Ionicons, Animated/reanimated, Haptics, router, useTheme, Habit from habits-context, IDENTITY_AREAS from identity-context
    - Export as named export: `export function HabitGridCard()`

    **HabitGridCard test (components/habits/HabitGridCard.test.tsx):**
    - Create a `mockHabit` factory function that returns a valid Habit object with all required fields
    - Test 1: "renders habit title" -- render with a mock habit, verify title text appears
    - Test 2: "shows checkmark when completed" -- render with `isCompleted={true}`, verify checkmark-circle icon
    - Test 3: "calls onComplete when check button pressed on incomplete habit" -- render with `isCompleted={false}`, press check button, verify onComplete called with habit.id
    - Use `waitFor` for all assertions (providers need hydration)

    **HabitStackView (components/habits/HabitStackView.tsx):**
    - Copy the entire `function HabitStackView()` (lines 420-657 of index.tsx) to its own file
    - Copy the `stackViewStyles` StyleSheet (lines 1344-1392)
    - Keep the existing prop interface inline: `{ habits: Habit[]; completedIds: Set<string>; onComplete: (id: string) => void; onUncomplete: (id: string) => void; }`
    - Imports needed: React, RN components, Ionicons, Haptics, router, useTheme, Habit from habits-context, formatTime from utils/time
    - Export as named export: `export function HabitStackView()`

    **HabitStackView test (components/habits/HabitStackView.test.tsx):**
    - Test 1: "renders standalone habits when no stacking" -- render with 2 habits that have no stackAnchor, verify both titles appear
    - Test 2: "renders empty hint when no habits provided" -- render with empty habits array, verify empty state message
    - Use `waitFor` for assertions
  </action>
  <verify>
    - `ls components/habits/HabitGridCard.tsx components/habits/HabitGridCard.test.tsx components/habits/HabitStackView.tsx components/habits/HabitStackView.test.tsx` -- all 4 files exist
    - `npx jest components/habits/HabitGridCard.test.tsx --no-coverage` passes
    - `npx jest components/habits/HabitStackView.test.tsx --no-coverage` passes
    - `npx jest --no-coverage` -- full suite passes (no regressions)
  </verify>
  <done>
    HabitGridCard and HabitStackView extracted to individual files with co-located tests. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `ls components/shared/*.tsx components/habits/*.tsx` shows 5 component files + 5 test files
2. `npx jest components/ --no-coverage` -- all component tests pass
3. `npx jest --no-coverage` -- full suite passes (no regressions from existing tests)
4. Each component file has a named export function
5. Each test file imports from `@/lib/test-utils` (custom render wrapper)
</verification>

<success_criteria>
- 5 component files extracted from index.tsx with proper exports
- 5 co-located test files, all passing
- No modifications to index.tsx yet (inline functions still there, components are extracted copies)
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-component-extraction-testing/03-02-SUMMARY.md`
</output>
